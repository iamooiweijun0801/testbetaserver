<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <title>KPI Dashboard - GSM/LTE</title>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/chartjs-plugin-annotation@2.0.1/dist/chartjs-plugin-annotation.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/pptxgenjs@3.12.0/dist/pptxgen.bundle.js"></script>
    <style>
        /* --- BASE STYLES --- */
        body { 
            font-family:'Segoe UI', Tahoma, Geneva, Verdana, sans-serif; 
            margin:0; 
            padding:0; 
            background:#f4f7f6; 
            overflow-x:hidden; 
        }
        header { 
            text-align:center; 
            padding:15px 0; 
            font-size:28px; 
            font-weight:700; 
            color:#333; 
            background:white; 
            box-shadow:0 2px 4px rgba(0,0,0,0.05); 
            margin-bottom:15px; 
        }
        
        /* --- TECH SWITCHER --- */
        .tech-switcher {
            display: flex;
            justify-content: center;
            gap: 10px;
            margin-bottom: 20px;
        }
        .tech-switcher button {
            padding: 10px 20px;
            border: none;
            border-radius: 6px;
            cursor: pointer;
            font-weight: 600;
            transition: 0.2s;
        }
        .tech-switcher button.active {
            color: white;
            transform: translateY(-2px);
            box-shadow: 0 4px 8px rgba(0,0,0,0.1);
        }
        .tech-switcher button.gsm-lte {
            background: #2F80ED;
            color: white;
        }
        .tech-switcher button.nr {
            background: #D24726;
            color: white;
        }
        
        /* --- CONTROLS --- */
        .controls-container {
            display: flex;
            justify-content: center;
            gap: 20px;
            margin-bottom: 20px;
            flex-wrap: wrap;
            align-items: center;
            padding: 0 20px;
        }
        
        /* --- GROUP FILTER --- */
        .group-filter-wrapper {
            display: flex;
            align-items: center;
        }
        .group-filter-container {
            position: relative;
            min-width: 250px;
        }
        .group-filter-dropdown {
            width: 100%;
            padding: 8px 12px;
            border: 1px solid #ddd;
            border-radius: 6px;
            background: white;
            cursor: pointer;
            display: flex;
            justify-content: space-between;
            align-items: center;
            min-height: 40px;
        }
        .group-filter-dropdown:hover {
            border-color: #2F80ED;
        }
        .group-options {
            position: absolute;
            top: 100%;
            left: 0;
            right: 0;
            background: white;
            border: 1px solid #ddd;
            border-radius: 6px;
            margin-top: 5px;
            padding: 10px;
            max-height: 300px;
            overflow-y: auto;
            z-index: 1000;
            display: none;
            box-shadow: 0 4px 12px rgba(0,0,0,0.1);
        }
        .group-options.show {
            display: block;
        }
        .group-option {
            padding: 8px 10px;
            cursor: pointer;
            border-radius: 4px;
            margin-bottom: 2px;
        }
        .group-option:hover {
            background: #f5f5f5;
        }
        .group-option.selected {
            background: #2F80ED;
            color: white;
        }
        .group-select-all-btn {
            width: 100%;
            padding: 8px;
            margin-bottom: 10px;
            background: #5cb85c;
            color: white;
            border: none;
            border-radius: 4px;
            cursor: pointer;
            font-weight: 600;
        }
        .group-select-all-btn:hover {
            background: #4cae4c;
        }
        .selected-group-display {
            font-weight: 500;
            color: #333;
        }
        
        /* --- SPACER BETWEEN FILTER AND EXPORT BUTTON --- */
        .controls-spacer {
            width: 20px;
            height: 1px;
        }
        
        /* --- EXPORT BUTTON --- */
        .export-btn-wrapper {
            display: flex;
            align-items: center;
        }
        
        /* --- DRAWER TOGGLE BUTTONS --- */
        .drawer-toggle-buttons { 
            position: fixed; 
            top: 20px; 
            right: 0; 
            display: flex; 
            flex-direction: column; 
            gap: 8px; 
            z-index: 900; 
        }
        .chartStyleDrawerToggle, .kpiDrawerToggle { 
            width: 36px; 
            height: 36px; 
            background: #8E44AD; 
            color: white; 
            border-radius: 6px 0 0 6px; 
            cursor: pointer; 
            display: flex; 
            align-items: center; 
            justify-content: center; 
            font-size: 20px; 
            transition: 0.2s; 
        }
        .kpiDrawerToggle { 
            background: #2F80ED; 
            margin-top: 8px; 
        }
        .chartStyleDrawerToggle:hover, .kpiDrawerToggle:hover { 
            opacity: 0.9; 
        }
        
        /* --- GRID LAYOUT (3 Graphs per row) --- */
        .chart-grid { 
            display:grid; 
            grid-template-columns: repeat(3, 1fr); 
            gap:20px; 
            padding:0 20px 40px 20px; 
            max-width: 1800px; 
            margin: 0 auto; 
        }
        @media (max-width: 1400px) { 
            .chart-grid { 
                grid-template-columns: repeat(2, 1fr); 
            } 
        }
        @media (max-width: 768px) { 
            .chart-grid { 
                grid-template-columns: 1fr; 
            } 
        }
        
        /* --- CARDS & CHARTS --- */
        .chart-card { 
            background:white; 
            border-radius:8px; 
            padding:15px; 
            box-shadow:0 2px 8px rgba(0,0,0,0.08); 
            display:flex; 
            flex-direction:column; 
            position: relative;
        }
        .chart-container { 
            position: relative; 
            height: 280px; 
            width: 100%; 
        }
        
        /* --- PERIOD LABELS --- */
        .period-label {
            position: absolute;
            top: 10px;
            font-size: 11px;
            font-weight: bold;
            padding: 2px 8px;
            border-radius: 3px;
            z-index: 10;
            border: 1px solid;
        }
        .pre-period {
            background-color: rgba(47, 128, 237, 0.15);
            color: #2F80ED;
            border-color: #2F80ED;
            left: 10px;
        }
        .post-period {
            background-color: rgba(39, 174, 96, 0.15);
            color: #27AE60;
            border-color: #27AE60;
            right: 10px;
        }
        
        /* --- DRAWERS --- */
        .chartStyleDrawer, .kpiDrawer { 
            position: fixed; 
            top: 0; 
            right: 0; 
            width: 320px; 
            height: 100%; 
            background: white; 
            box-shadow: -2px 0 10px rgba(0,0,0,0.1); 
            z-index: 1000; 
            transform: translateX(100%); 
            transition: 0.3s; 
            padding: 20px; 
            display: flex; 
            flex-direction: column; 
        }
        .chartStyleDrawer.open, .kpiDrawer.open { 
            transform: translateX(0); 
        }
        .drawer-header { 
            display: flex; 
            justify-content: space-between; 
            align-items: center; 
            margin-bottom: 15px; 
            padding-bottom: 10px; 
            border-bottom: 1px solid #eee; 
        }
        .kpi-options-body, .style-options-body { 
            flex-grow: 1; 
            overflow-y: auto; 
            padding-right: 5px; 
            padding-bottom: 40px; 
        }
        .drawer-controls { 
            display: flex; 
            gap: 5px; 
            align-items: center; 
        }
        .drawer-controls .action-btn { 
            padding: 6px 10px; 
            font-size: 13px; 
        }

        /* --- KPI OPTIONS STYLING --- */
        .kpi-group-title { 
            font-weight: bold; 
            color: #2F80ED; 
            margin-top: 15px; 
            margin-bottom: 5px; 
            border-bottom: 1px solid #eee; 
            padding-bottom: 3px; 
        }
        .kpi-option { 
            display: block; 
            margin-bottom: 5px; 
            cursor: pointer; 
            user-select: none; 
        }
        .kpi-option input[type="checkbox"] { 
            margin-right: 8px; 
        }
        
        /* --- Chart Style Buttons --- */
        .style-button { 
            padding: 10px 12px; 
            margin: 6px 0; 
            background: #f5f5f5; 
            border-radius: 6px; 
            cursor: pointer; 
            font-weight: 500; 
            border: 1px solid #ddd; 
            transition: 0.2s; 
        }
        .style-button:hover { 
            background: #e9e9e9; 
        }
        .style-button.active { 
            background: #8E44AD; 
            color: white; 
            border-color: #8E44AD; 
        }
        
        /* --- TECH COLOR BUTTONS --- */
        .tech-color-buttons {
            display: grid;
            grid-template-columns: repeat(2, 1fr);
            gap: 8px;
            margin-top: 15px;
        }
        .tech-color-btn {
            padding: 8px;
            border: none;
            border-radius: 6px;
            cursor: pointer;
            font-weight: 500;
            color: white;
            text-align: center;
        }
        .tech-color-btn.gsm { background: #2F80ED; }
        .tech-color-btn.lte { background: #27AE60; }

        /* --- PRE/POST COLOR BUTTONS --- */
        .prepost-color-buttons {
            display: grid;
            grid-template-columns: repeat(2, 1fr);
            gap: 8px;
            margin-top: 15px;
        }
        .prepost-color-btn {
            padding: 8px;
            border: none;
            border-radius: 6px;
            cursor: pointer;
            font-weight: 500;
            color: white;
            text-align: center;
        }
        .prepost-color-btn.pre { background: #2F80ED; }
        .prepost-color-btn.post { background: #27AE60; }

        /* --- COLOR PICKER MODAL --- */
        .color-picker-modal {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0,0,0,0.5);
            z-index: 2000;
            display: none;
            justify-content: center;
            align-items: center;
        }
        .color-picker-content {
            background: white;
            padding: 20px;
            border-radius: 8px;
            width: 300px;
            text-align: center;
        }
        .color-picker-grid {
            display: grid;
            grid-template-columns: repeat(4, 1fr);
            gap: 10px;
            margin: 15px 0;
        }
        .color-option {
            width: 50px;
            height: 50px;
            border-radius: 6px;
            cursor: pointer;
            margin: 0 auto;
            border: 2px solid transparent;
        }
        .color-option.selected {
            border: 2px solid #333;
        }
        .color-picker-actions {
            display: flex;
            gap: 10px;
            justify-content: center;
            margin-top: 15px;
        }
        
        /* --- PPT EXPORT MODAL --- */
        .modal {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0,0,0,0.6);
            z-index: 2001;
            display: none;
            align-items: center;
            justify-content: center;
            backdrop-filter: blur(3px);
        }
        .modal-content {
            background: white;
            width: 95%;
            max-width: 1400px;
            height: 90vh;
            border-radius: 12px;
            display: flex;
            flex-direction: column;
            box-shadow: 0 10px 25px rgba(0,0,0,0.3);
        }
        .modal-header {
            padding: 15px 20px;
            border-bottom: 1px solid #eee;
            display: flex;
            justify-content: space-between;
            align-items: center;
            font-weight: bold;
            font-size: 18px;
        }
        .modal-body {
            flex: 1;
            display: flex;
            padding: 0;
            overflow: hidden;
        }
        #previewBody {
            flex: 1;
            overflow-y: auto;
            padding: 20px;
            background: #f5f5f5;
        }
        .preview-slide {
            background: white;
            border: 1px solid #ddd;
            margin-bottom: 20px;
            padding: 20px;
            box-shadow: 0 2px 5px rgba(0,0,0,0.05);
            aspect-ratio: 16/9;
            position: relative;
        }
        .preview-slide-title {
            position: absolute;
            top: 10px;
            left: 20px;
            font-size: 16px;
            font-weight: bold;
            color: #D24726;
        }
        .preview-grid {
            display: grid;
            height: 100%;
            align-items: center;
            padding-top: 30px;
        }
        .preview-img-box {
            text-align: center;
            padding: 5px;
            height: 100%;
            display: flex;
            flex-direction: column;
            justify-content: center;
        }
        .preview-img-box img {
            max-width: 100%;
            max-height: calc(100% - 20px);
            object-fit: contain;
            border: 1px solid #eee;
        }
        #previewSettingsPanel {
            width: 250px;
            background: #fff;
            border-left: 1px solid #eee;
            padding: 20px;
            display: flex;
            flex-direction: column;
            flex-shrink: 0;
        }
        .settings-group {
            margin-bottom: 20px;
        }
        .settings-group h4 {
            margin-top: 0;
            margin-bottom: 10px;
            font-size: 14px;
            color: #555;
            border-bottom: 1px solid #eee;
            padding-bottom: 5px;
        }
        .graph-options {
            display: flex;
            flex-wrap: wrap;
            gap: 5px;
        }
        .graph-options button {
            padding: 6px 10px;
            font-size: 13px;
            background: #f0f0f0;
            border: 1px solid #ddd;
            border-radius: 4px;
            cursor: pointer;
        }
        .graph-options button.active {
            background: #2F80ED;
            color: white;
            border-color: #2F80ED;
        }
        .tech-export-options {
            display: flex;
            flex-direction: column;
            gap: 5px;
        }
        .tech-export-option {
            display: flex;
            align-items: center;
            gap: 8px;
        }
        .tech-export-option input {
            margin: 0;
        }
        .modal-footer {
            padding: 15px 20px;
            border-top: 1px solid #eee;
            text-align: right;
            flex-shrink: 0;
        }
    </style>
</head>
<body onload="initDashboard()">
    <header>KPI Dashboard - GSM/LTE</header>

    <div class="tech-switcher">
        <button class="gsm-lte active" onclick="switchToDashboard('gsm-lte')">GSM/LTE</button>
        <button class="nr" onclick="switchToDashboard('nr')">NR</button>
    </div>

    <div class="controls-container">
        <div class="group-filter-wrapper">
            <div class="group-filter-container">
                <div class="group-filter-dropdown" onclick="toggleGroupFilter()">
                    <span class="selected-group-display" id="selectedGroupDisplay">Select Group</span>
                    <span>â–¼</span>
                </div>
                <div class="group-options" id="groupOptions">
                    <button class="group-select-all-btn" onclick="selectAllGroups()">Select All (Aggregate)</button>
                    <div id="groupOptionsList">
                        <!-- Group options will be loaded here -->
                    </div>
                </div>
            </div>
        </div>
        
        <!-- Invisible spacer to prevent overlap -->
        <div class="controls-spacer"></div>
        
        <div class="export-btn-wrapper">
            <button class="action-btn" onclick="openPPTExport()">ðŸ“Š Export PPT</button>
        </div>
    </div>

    <div class="chart-grid" id="mainChartContainer">
        <!-- Charts will be loaded here -->
    </div>

    <!-- Drawer Toggle Buttons -->
    <div class="drawer-toggle-buttons">
        <div class="chartStyleDrawerToggle" onclick="toggleChartStyleDrawer()">ðŸŽ¨</div>
        <div class="kpiDrawerToggle" onclick="toggleDrawer()">âš™</div>
    </div>

    <!-- Chart Style Drawer -->
    <div id="chartStyleDrawer" class="chartStyleDrawer">
        <div class="drawer-header"> 
            <h3>Chart Styles</h3> 
            <button onclick="toggleChartStyleDrawer()" style="border:none; background:none; font-size:22px; cursor:pointer;">âœ•</button> 
        </div>
        <div class="style-options-body">
            <div class="style-button" onclick="applyChartStyle(0)">Filled Area</div>
            <div class="style-button" onclick="applyChartStyle(1)">Line with Dots</div>
            <div class="style-button" onclick="applyChartStyle(2)">Smooth Line</div>
            <div class="style-button" onclick="applyChartStyle(3)">Thick Line</div>
            <div class="style-button" onclick="applyChartStyle(4)">Thin Line with dots</div>
            
            <div style="margin: 20px 0; border-top: 1px solid #eee; padding-top: 15px;">
                <label><b>Technology Colors</b></label>
                <div class="tech-color-buttons">
                    <button class="tech-color-btn gsm" onclick="openColorPicker('GSM')">GSM Color</button>
                    <button class="tech-color-btn lte" onclick="openColorPicker('LTE')">LTE Color</button>
                </div>
            </div>
            
            <div style="margin: 20px 0; border-top: 1px solid #eee; padding-top: 15px;">
                <label><b>Pre/Post Colors</b></label>
                <div class="prepost-color-buttons">
                    <button class="prepost-color-btn pre" onclick="openColorPicker('PRE')">PRE Color</button>
                    <button class="prepost-color-btn post" onclick="openColorPicker('POST')">POST Color</button>
                </div>
            </div>
        </div>
    </div>

    <!-- KPI Settings Drawer -->
    <div id="kpiDrawer" class="kpiDrawer">
        <div class="drawer-header"> 
            <h3 id="drawerHeaderTitle">KPI Settings</h3> 
            <button onclick="toggleDrawer()" style="border:none; background:none; font-size:24px; cursor:pointer; color:#777;">âœ•</button> 
        </div>
        <div class="drawer-controls">
            <button class="action-btn" onclick="selectVisibleKpis()" style="background:#5cb85c;">Select All</button>
            <button class="action-btn" onclick="clearVisibleKpis()" style="background:#f0ad4e;">Clear All</button>
            <button class="action-btn" onclick="applyKpis()" style="background:#2F80ED;">Apply</button>
        </div>
        <div class="kpi-options-body" id="kpiOptionsList">
            <!-- KPI options will be loaded here -->
        </div>
    </div>

    <!-- Color Picker Modal -->
    <div id="colorPickerModal" class="color-picker-modal">
        <div class="color-picker-content">
            <h3 id="colorPickerTitle">Select Color</h3>
            <div class="color-picker-grid" id="colorPickerGrid">
                <!-- Color options will be added here -->
            </div>
            <div class="color-picker-actions">
                <button class="action-btn" onclick="closeColorPicker()" style="background:#888;">Cancel</button>
                <button class="action-btn" onclick="applySelectedColor()" style="background:#27AE60;">Apply</button>
            </div>
        </div>
    </div>

    <!-- PPT Export Modal -->
    <div id="pptModal" class="modal">
        <div class="modal-content">
            <div class="modal-header">
                <span>PPT Export Preview</span>
                <button onclick="closePPTExport()" style="border:none; background:none; font-size:20px; cursor:pointer;">âœ•</button>
            </div>
            <div class="modal-body">
                <div id="previewBody">
                    <!-- Preview slides will be loaded here -->
                </div>
                <div id="previewSettingsPanel">
                    <h3>Export Settings</h3>
                    
                    <div class="settings-group">
                        <h4>Layout</h4>
                        <div class="graph-options">
                            <button onclick="updatePPTPreview(1)" data-count="1">1 Graph</button>
                            <button onclick="updatePPTPreview(2)" data-count="2">2 Graphs</button>
                            <button onclick="updatePPTPreview(3)" data-count="3">3 Graphs</button>
                            <button onclick="updatePPTPreview(4)" data-count="4">4 Graphs</button>
                            <button onclick="updatePPTPreview(6)" data-count="6">6 Graphs</button>
                            <button onclick="updatePPTPreview(9)" data-count="9">9 Graphs</button>
                        </div>
                    </div>
                    
                    <div class="settings-group">
                        <h4>Select Technologies</h4>
                        <div class="tech-export-options" id="techExportOptions">
                            <!-- Technology checkboxes will be added here -->
                        </div>
                    </div>
                    
                    <div class="settings-group">
                        <h4>Export Options</h4>
                        <div style="font-size: 12px; color: #666; margin-top: 10px;">
                            <p>â€¢ Maintains chart colors</p>
                            <p>â€¢ Preserves chart titles</p>
                            <p>â€¢ Optimized for PowerPoint</p>
                        </div>
                    </div>
                </div>
            </div>
            <div class="modal-footer">
                <button class="action-btn" onclick="closePPTExport()" style="background:#888;">Cancel</button>
                <button class="action-btn ppt-btn" onclick="downloadPPT()" style="background:#D24726;">Download PPT</button>
            </div>
        </div>
    </div>

    <script>
        // --- CONFIG & STATE ---
        let allData = [];
        let allCharts = {};
        let selectedKpis = [];
        let selectedColorTarget = ''; // 'GSM', 'LTE', 'PRE', or 'POST'
        let selectedColor = '';
        let pptLayout = 9; // Default: 3 graphs per slide
        let selectedTechForExport = {
            GSM: true,
            LTE: true
        };
        
        // --- GROUP FILTER STATE ---
        let availableGroups = [];
        let selectedGroups = []; // Will contain either ONE group name or be empty (for "All")
        let groupColumnName = ''; // Will be detected from data (eNodeB Name for LTE, GBSC for GSM)
        let isAllGroupsSelected = false; // Flag to track if "Select All" is active
        let dateHeaderName = ''; // Store the date header name globally

        // --- KPI Definitions (GSM/LTE only) ---
        const kpiDefinitions = [
            { tech: "GSM", kpi: "Call setup success rate(%)", initialChecked: true, color: "#2F80ED" },
            { tech: "GSM", kpi: "Call drop rate(%)", initialChecked: true, color: "#2F80ED" },
            { tech: "GSM", kpi: "CS Traffic (erl)", initialChecked: true, color: "#2F80ED" },
            
            { tech: "LTE", kpi: "Call Setup Success Rate(%)", initialChecked: true, color: "#27AE60" },
            { tech: "LTE", kpi: "E-RAB Call Drop Rate(%)", initialChecked: true, color: "#27AE60" },
            { tech: "LTE", kpi: "DL -USER Average Throughput (Mbit/s)", initialChecked: true, color: "#27AE60" },
            { tech: "LTE", kpi: "UL -USER Average Throughput (Mbit/s)", initialChecked: true, color: "#27AE60" },
            { tech: "LTE", kpi: "DL Data Total Volume (Gbyte)", initialChecked: true, color: "#27AE60" },
            { tech: "LTE", kpi: "UL Data Total Volume (Gbyte)", initialChecked: true, color: "#27AE60" },
            { tech: "LTE", kpi: "DL PRB Utilization (%)", initialChecked: true, color: "#27AE60" }
        ];

        // --- Sheet URLs (GSM/LTE only) ---
        const sheetUrls = {
            GSM: "https://docs.google.com/spreadsheets/d/e/2PACX-1vRIeWBt5CB8zpdFja0b3h2kodVsUrjD_PSHOkF93MkecZF04gWDoMXVq-q0REU-RvFQbjVggJVDLpUi/pub?gid=1977848975&single=true&output=csv",
            LTE: "https://docs.google.com/spreadsheets/d/e/2PACX-1vRIeWBt5CB8zpdFja0b3h2kodVsUrjD_PSHOkF93MkecZF04gWDoMXVq-q0REU-RvFQbjVggJVDLpUi/pub?gid=893314169&single=true&output=csv"
        };
        
        let activeChartStyle = null;
        let techColors = {
            GSM: "#2F80ED",
            LTE: "#27AE60"
        };
        
        // Pre/Post Colors
        let prePostColors = {
            PRE: "#2F80ED", // Blue for pre
            POST: "#27AE60"  // Green for post
        };

        // --- Color Palette Options ---
        const colorPalette = [
            "#2F80ED", "#27AE60", "#D24726", "#8E44AD",
            "#3498DB", "#2ECC71", "#E74C3C", "#9B59B6",
            "#1ABC9C", "#F39C12", "#34495E", "#95A5A6",
            "#2980B9", "#16A085", "#C0392B", "#8E44AD"
        ];

        // --- Chart Styles ---
        const chartStyles = [
            { 
                name: "Filled Area", 
                borderWidth: 2, 
                pointRadius: 0, 
                borderDash: [], 
                tension: 0.2, 
                fill: true, 
                backgroundColor: "rgba(47, 128, 237, 0.1)" 
            },
            { 
                name: "Line with Dots", 
                borderWidth: 3, 
                pointRadius: 5, 
                borderDash: [], 
                tension: 0.4, 
                fill: false 
            },
            { 
                name: "Smooth Line", 
                borderWidth: 2, 
                pointRadius: 0, 
                borderDash: [], 
                tension: 0.4, 
                fill: false 
            },
            { 
                name: "Thick Line", 
                borderWidth: 4, 
                pointRadius: 0, 
                borderDash: [], 
                tension: 0.3, 
                fill: false 
            },
            { 
                name: "Thin Line with dots", 
                borderWidth: 2, 
                pointRadius: 4, 
                borderDash: [], 
                tension: 0, 
                fill: false 
            }
        ];

        // --- ACTION BUTTON STYLING ---
        const actionBtnStyle = `
            .action-btn { 
                padding: 8px 16px; 
                cursor: pointer; 
                border: none; 
                background: #2F80ED; 
                color: white; 
                border-radius: 6px; 
                font-weight: 600; 
                transition: 0.2s; 
            }
            .action-btn:hover { 
                background: #1f5ab5; 
            }
            .ppt-btn {
                background: #D24726 !important;
            }
            .ppt-btn:hover {
                background: #a8381e !important;
            }
        `;
        
        const style = document.createElement('style');
        style.textContent = actionBtnStyle;
        document.head.appendChild(style);

        // --- DASHBOARD SWITCHER ---
        function switchToDashboard(type) {
            if (type === 'gsm-lte') {
                // Already here
                return;
            } else if (type === 'nr') {
                window.location.href = 'nr.html';
            }
        }

        // --- INITIALIZATION ---
        function initDashboard() {
            selectedKpis = kpiDefinitions.filter(k => k.initialChecked).map(k => k.tech + " - " + k.kpi);
            applyChartStyle(1);
            fetchData();
        }

        // --- DATA FETCHING ---
        async function fetchData(){
            document.getElementById("mainChartContainer").innerHTML = "<h2 style='text-align:center;padding:40px;color:#666;'>Loading data...</h2>";
            allData = [];
            availableGroups = [];
            selectedGroups = [];
            isAllGroupsSelected = false;
            
            try {
                for (const tech in sheetUrls) {
                    try {
                        const url = sheetUrls[tech] + "&t=" + Date.now();
                        const res = await fetch(url);
                        if (!res.ok) continue;
                        const text = await res.text();
                        if (!text || text.trim() === '') continue;
                        const rows = text.trim().split('\n').map(r => r.split(','));
                        
                        if (rows.length < 2) continue;
                        
                        const headers = rows.shift().map(h => h.trim());
                        const dateHeader = headers.find(h => h.toLowerCase().includes('date'));
                        
                        if (!dateHeaderName && dateHeader) {
                            dateHeaderName = dateHeader;
                        }
                        
                        // Detect group column name for this technology
                        let groupColumn = '';
                        if (tech === 'LTE') {
                            groupColumn = headers.find(h => h.toLowerCase().includes('enodeb') || h.toLowerCase().includes('site'));
                        } else if (tech === 'GSM') {
                            groupColumn = headers.find(h => h.toLowerCase().includes('gbsc') || h.toLowerCase().includes('bsc'));
                        }
                        
                        if (!groupColumn) {
                            groupColumn = headers.find(h => 
                                h.toLowerCase().includes('name') || 
                                h.toLowerCase().includes('group') || 
                                h.toLowerCase().includes('site') ||
                                h.toLowerCase().includes('cell')
                            );
                        }
                        
                        if (!groupColumnName && groupColumn) {
                            groupColumnName = groupColumn;
                        }
                        
                        rows.forEach(r => {
                            const obj = {};
                            headers.forEach((h, i) => {
                                const val = r[i] ? r[i].trim() : "";
                                obj[h] = val === "" ? null : (isNaN(val) ? val : parseFloat(val));
                            });
                            if (obj[dateHeader]) {
                                obj.Tech = tech;
                                obj.Group = obj[groupColumn] || 'Unknown';
                                allData.push(obj);
                                
                                // Add to available groups
                                if (obj[groupColumn] && !availableGroups.includes(obj[groupColumn])) {
                                    availableGroups.push(obj[groupColumn]);
                                }
                            }
                        });
                    } catch (e) {
                        console.error(`Error loading ${tech} data:`, e);
                    }
                }

                if (allData.length === 0) {
                    throw new Error("No data loaded from any source");
                }
                
                // Initialize selected groups (FIRST GROUP SELECTED BY DEFAULT)
                if (availableGroups.length > 0) {
                    selectedGroups = [availableGroups[0]]; // Only first group
                    isAllGroupsSelected = false;
                }
                
                populateGroupFilter();
                updateSelectedGroupDisplay();
                
                // Render charts with timeline for selected group
                renderCharts();

            } catch(e) {
                console.error("Data loading error:", e);
                document.getElementById("mainChartContainer").innerHTML = "<h2 style='text-align:center;padding:40px;color:#D24726;'>Failed to load data. Check console for details.</h2>";
            }
        }

        // --- GROUP FILTER FUNCTIONS ---
        function populateGroupFilter() {
            const groupOptionsList = document.getElementById('groupOptionsList');
            groupOptionsList.innerHTML = '';
            
            // Sort groups
            availableGroups.sort().forEach(group => {
                const optionDiv = document.createElement('div');
                optionDiv.className = 'group-option';
                optionDiv.textContent = group;
                optionDiv.dataset.group = group;
                
                // Check if this group is selected (for single selection)
                if (selectedGroups[0] === group && !isAllGroupsSelected) {
                    optionDiv.classList.add('selected');
                }
                
                optionDiv.onclick = (e) => {
                    selectSingleGroup(group);
                    e.stopPropagation();
                };
                
                groupOptionsList.appendChild(optionDiv);
            });
        }
        
        function toggleGroupFilter() {
            const groupOptions = document.getElementById('groupOptions');
            groupOptions.classList.toggle('show');
            
            // Close other dropdowns if open
            document.addEventListener('click', function closeDropdown(e) {
                if (!e.target.closest('.group-filter-container')) {
                    groupOptions.classList.remove('show');
                    document.removeEventListener('click', closeDropdown);
                }
            });
        }
        
        function selectSingleGroup(group) {
            // Single selection mode - only select one group
            selectedGroups = [group];
            isAllGroupsSelected = false;
            
            // Update UI
            const options = document.querySelectorAll('.group-option');
            options.forEach(opt => {
                if (opt.dataset.group === group) {
                    opt.classList.add('selected');
                } else {
                    opt.classList.remove('selected');
                }
            });
            
            updateSelectedGroupDisplay();
            applyGroupFilter();
            
            // Close dropdown
            document.getElementById('groupOptions').classList.remove('show');
        }
        
        function selectAllGroups() {
            // Select all groups (aggregate mode)
            selectedGroups = []; // Empty array means all groups
            isAllGroupsSelected = true;
            
            // Update UI
            const options = document.querySelectorAll('.group-option');
            options.forEach(opt => {
                opt.classList.remove('selected');
            });
            
            updateSelectedGroupDisplay();
            applyGroupFilter();
            
            // Close dropdown
            document.getElementById('groupOptions').classList.remove('show');
        }
        
        function updateSelectedGroupDisplay() {
            const displayElement = document.getElementById('selectedGroupDisplay');
            if (isAllGroupsSelected) {
                displayElement.textContent = 'All Groups (Aggregated)';
            } else if (selectedGroups.length > 0) {
                displayElement.textContent = selectedGroups[0];
            } else {
                displayElement.textContent = 'Select Group';
            }
        }
        
        function applyGroupFilter() {
            renderCharts();
        }

        // --- CHART RENDERING with SEPARATE PRE/POST LINES ---
        function renderCharts() {
            const container = document.getElementById("mainChartContainer");
            container.innerHTML = "";
            allCharts = {};
            
            if (allData.length === 0) {
                container.innerHTML = "<h2 style='text-align:center;padding:40px;color:#666;'>No data available.</h2>";
                return;
            }

            // Get timeline based on selected filter
            let timeline = [];
            
            if (isAllGroupsSelected) {
                timeline = [...new Set(allData.map(d => d[dateHeaderName]))];
            } else if (selectedGroups.length > 0) {
                timeline = [...new Set(
                    allData
                        .filter(d => d.Group === selectedGroups[0])
                        .map(d => d[dateHeaderName])
                )];
            } else {
                container.innerHTML = "<h2 style='text-align:center;padding:40px;color:#666;'>No group selected.</h2>";
                return;
            }

            // Sort timeline
            timeline.sort((a,b)=>{
                const [da,ma,ya]=a.split('/').map(Number);
                const [db,mb,yb]=b.split('/').map(Number);
                return new Date(ya,ma-1,da)-new Date(yb,mb-1,db);
            });

            if (timeline.length === 0) {
                container.innerHTML = "<h2 style='text-align:center;padding:40px;color:#666;'>No timeline data available.</h2>";
                return;
            }

            const monthNames = ["Jan", "Feb", "Mar", "Apr", "May", "Jun", "Jul", "Aug", "Sep", "Oct", "Nov", "Dec"];
            const timelineLabels = timeline.map(d => {
                const [day, month] = d.split('/').map(Number);
                return `${day} ${monthNames[month - 1]}`;
            });

            // Split timeline in half for pre/post
            const splitIndex = Math.floor(timeline.length / 2);

            const chartsToRender = kpiDefinitions.filter(k => selectedKpis.includes(k.tech + " - " + k.kpi));
            
            if (chartsToRender.length === 0) {
                container.innerHTML = "<h2 style='text-align:center;padding:40px;color:#666;'>No KPIs selected. Please select KPIs from settings drawer.</h2>";
                return;
            }

            chartsToRender.forEach((kpiDef, idx) => {
                const fullKpiName = kpiDef.tech + " - " + kpiDef.kpi;
                const tech = kpiDef.tech;
                const kpi = kpiDef.kpi;

                const card = document.createElement("div");
                card.className = "chart-card";
                card.style.position = "relative";
                
                // Add period labels to card
                const preLabel = document.createElement("div");
                preLabel.className = "period-label pre-period";
                preLabel.textContent = "PRE";
                card.appendChild(preLabel);
                
                const postLabel = document.createElement("div");
                postLabel.className = "period-label post-period";
                postLabel.textContent = "POST";
                card.appendChild(postLabel);
                
                const wrapper = document.createElement("div");
                wrapper.className = "chart-container";
                const canvas = document.createElement("canvas");
                canvas.id = `chart_${idx}`;
                wrapper.appendChild(canvas);
                card.appendChild(wrapper);
                container.appendChild(card);

                // Data Processing - SEPARATE for pre and post
                const preDataPoints = [];
                const postDataPoints = [];
                
                // Process pre period data
                for (let i = 0; i < splitIndex; i++) {
                    const date = timeline[i];
                    let filteredData = allData.filter(d => d.Tech === tech && d[dateHeaderName] === date);
                    
                    if (!isAllGroupsSelected && selectedGroups.length > 0) {
                        filteredData = filteredData.filter(d => d.Group === selectedGroups[0]);
                    }
                    
                    const values = filteredData
                        .map(d => d[kpi])
                        .filter(v => v !== null && v !== "")
                        .map(Number)
                        .filter(v => !isNaN(v));
                    
                    if (values.length === 0) {
                        preDataPoints.push(null);
                        continue;
                    }
                    
                    const kpiLower = kpi.toLowerCase();
                    if (kpiLower.includes('%') || kpiLower.includes('rate') || kpiLower.includes('avg') || kpiLower.includes('average')|| kpiLower.includes('max')) {
                        preDataPoints.push(values.reduce((a, b) => a + b, 0) / values.length);
                    } else {
                        preDataPoints.push(values.reduce((a, b) => a + b, 0));
                    }
                }
                
                // Process post period data
                for (let i = splitIndex; i < timeline.length; i++) {
                    const date = timeline[i];
                    let filteredData = allData.filter(d => d.Tech === tech && d[dateHeaderName] === date);
                    
                    if (!isAllGroupsSelected && selectedGroups.length > 0) {
                        filteredData = filteredData.filter(d => d.Group === selectedGroups[0]);
                    }
                    
                    const values = filteredData
                        .map(d => d[kpi])
                        .filter(v => v !== null && v !== "")
                        .map(Number)
                        .filter(v => !isNaN(v));
                    
                    if (values.length === 0) {
                        postDataPoints.push(null);
                        continue;
                    }
                    
                    const kpiLower = kpi.toLowerCase();
                    if (kpiLower.includes('%') || kpiLower.includes('rate') || kpiLower.includes('avg') || kpiLower.includes('average')|| kpiLower.includes('max')) {
                        postDataPoints.push(values.reduce((a, b) => a + b, 0) / values.length);
                    } else {
                        postDataPoints.push(values.reduce((a, b) => a + b, 0));
                    }
                }

                // Combine all valid values for Y-axis calculation
                const allValidValues = [...preDataPoints, ...postDataPoints].filter(v => v !== null);
                if (allValidValues.length === 0) {
                    const noDataMsg = document.createElement("div");
                    noDataMsg.style.textAlign = "center";
                    noDataMsg.style.padding = "20px";
                    noDataMsg.style.color = "#666";
                    if (isAllGroupsSelected) {
                        noDataMsg.textContent = "No data available for this KPI";
                    } else {
                        noDataMsg.textContent = `No data available for ${selectedGroups[0]}`;
                    }
                    card.appendChild(noDataMsg);
                    return;
                }

                let minVal = Math.min(...allValidValues);
                let maxVal = Math.max(...allValidValues);

                // Y-Axis Helper Functions
                function niceNumber(value, round) {
                    if (value === 0) return 0;
                    const exponent = Math.floor(Math.log10(value));
                    const fraction = value / Math.pow(10, exponent);
                    let niceFraction;
                    if (round) {
                        if (fraction < 1.5) niceFraction = 1; 
                        else if (fraction < 3) niceFraction = 2; 
                        else if (fraction < 7) niceFraction = 5; 
                        else niceFraction = 10;
                    } else {
                        if (fraction <= 1) niceFraction = 1; 
                        else if (fraction <= 2) niceFraction = 2; 
                        else if (fraction <= 5) niceFraction = 5; 
                        else niceFraction = 10;
                    }
                    return niceFraction * Math.pow(10, exponent);
                }
  
                function computeYAxis(minVal, maxVal) {
                    if (minVal >= 98 && maxVal <= 100) {
                        return { niceMin: 98, niceMax: 100, tickSpacing: 0.5 };
                    }
                    let minV = minVal * 0.95; 
                    let maxV = maxVal * 1.05;
                    if (maxVal < 10) minV = 0;
                    if (maxVal > 90 && maxVal <= 100) maxV = 100;
                    let range = maxV - minV;
                    if (range === 0) range = Math.abs(maxV) * 0.1 || 1;
                    const tickSpacing = niceNumber(range / 5, true);
                    const niceMin = Math.floor(minV / tickSpacing) * tickSpacing;
                    const niceMax = Math.ceil(maxV / tickSpacing) * tickSpacing;
                    return { niceMin, niceMax, tickSpacing };
                }
                
                const { niceMin, niceMax, tickSpacing } = computeYAxis(minVal, maxVal);

                // Create TWO SEPARATE datasets for pre and post
                const datasets = [
                    // PRE period dataset
                    {
                        label: 'PRE - ' + kpi,
                        data: [...preDataPoints, ...Array(postDataPoints.length).fill(null)], // Fill post positions with null
                        borderColor: prePostColors.PRE,
                        backgroundColor: activeChartStyle && activeChartStyle.fill ? 
                            prePostColors.PRE.replace(')', ', 0.1)').replace('rgb', 'rgba') : 'transparent',
                        borderWidth: activeChartStyle ? activeChartStyle.borderWidth : 2,
                        pointRadius: activeChartStyle ? activeChartStyle.pointRadius : 5,
                        pointBackgroundColor: prePostColors.PRE,
                        pointBorderColor: prePostColors.PRE,
                        pointBorderWidth: 1,
                        tension: activeChartStyle ? activeChartStyle.tension : 0.4,
                        spanGaps: true,
                        fill: activeChartStyle ? activeChartStyle.fill : false
                    },
                    // POST period dataset
                    {
                        label: 'POST - ' + kpi,
                        data: [...Array(preDataPoints.length).fill(null), ...postDataPoints], // Fill pre positions with null
                        borderColor: prePostColors.POST,
                        backgroundColor: activeChartStyle && activeChartStyle.fill ? 
                            prePostColors.POST.replace(')', ', 0.1)').replace('rgb', 'rgba') : 'transparent',
                        borderWidth: activeChartStyle ? activeChartStyle.borderWidth : 2,
                        pointRadius: activeChartStyle ? activeChartStyle.pointRadius : 5,
                        pointBackgroundColor: prePostColors.POST,
                        pointBorderColor: prePostColors.POST,
                        pointBorderWidth: 1,
                        tension: activeChartStyle ? activeChartStyle.tension : 0.4,
                        spanGaps: true,
                        fill: activeChartStyle ? activeChartStyle.fill : false
                    }
                ];

                // Chart Config
                const chartConfig = {
                    type: 'line',
                    data: {
                        labels: timelineLabels,
                        datasets: datasets
                    },
                    options: {
                        responsive: true, 
                        maintainAspectRatio: false,
                        plugins: { 
                            legend: { 
                                display: false // LEGEND REMOVED AS REQUESTED
                            },
                            title: { 
                                display: true, 
                                text: `${tech} - ${kpi}`,
                                font: { 
                                    size: 14, 
                                    weight: 'bold' 
                                }, 
                                color: '#333'
                            },
                            subtitle: {
                                display: true,
                                text: isAllGroupsSelected ? 
                                    'All Groups (Aggregated)' : 
                                    `Group: ${selectedGroups[0]}`,
                                font: {
                                    size: 10,
                                    style: 'italic'
                                },
                                color: '#666',
                                position: 'bottom'
                            },
                            // Add vertical line annotation
                            annotation: {
                                annotations: {
                                    prePostDivider: {
                                        type: 'line',
                                        xMin: splitIndex - 0.5,
                                        xMax: splitIndex - 0.5,
                                        yMin: '0%',
                                        yMax: '100%',
                                        borderColor: '#ff6b6b',
                                        borderWidth: 2,
                                        borderDash: [5, 5],
                                        label: {
                                            enabled: true,
                                            content: 'Pre/Post',
                                            position: 'top',
                                            backgroundColor: '#ff6b6b',
                                            color: 'white',
                                            font: {
                                                size: 10,
                                                weight: 'bold'
                                            },
                                            padding: {
                                                top: 2,
                                                bottom: 2,
                                                left: 6,
                                                right: 6
                                            },
                                            yAdjust: -15
                                        }
                                    }
                                }
                            },
                            // Enhanced tooltip
                            tooltip: {
                                callbacks: {
                                    title: function(tooltipItems) {
                                        const index = tooltipItems[0].dataIndex;
                                        const period = index < splitIndex ? 'PRE - ' : 'POST - ';
                                        return period + timelineLabels[index];
                                    },
                                    label: function(context) {
                                        const datasetLabel = context.dataset.label;
                                        const period = datasetLabel.startsWith('PRE') ? 'Pre Period' : 'Post Period';
                                        const value = context.parsed.y;
                                        if (value === null) return null;
                                        return `${period}: ${value.toFixed(2)}`;
                                    },
                                    labelColor: function(context) {
                                        const datasetLabel = context.dataset.label;
                                        const color = datasetLabel.startsWith('PRE') ? prePostColors.PRE : prePostColors.POST;
                                        return {
                                            borderColor: color,
                                            backgroundColor: color,
                                            borderWidth: 2,
                                            borderRadius: 2
                                        };
                                    }
                                }
                            },
                            // Add background shading
                            afterDraw: function(chart) {
                                const ctx = chart.ctx;
                                const xAxis = chart.scales.x;
                                const yAxis = chart.scales.y;
                                
                                if (chart.data.labels.length > 0) {
                                    ctx.save();
                                    
                                    // Pre period background
                                    ctx.fillStyle = prePostColors.PRE.replace(')', ', 0.05)').replace('rgb', 'rgba');
                                    ctx.fillRect(
                                        xAxis.getPixelForTick(0),
                                        yAxis.top,
                                        xAxis.getPixelForTick(splitIndex) - xAxis.getPixelForTick(0),
                                        yAxis.bottom - yAxis.top
                                    );
                                    
                                    // Post period background
                                    ctx.fillStyle = prePostColors.POST.replace(')', ', 0.05)').replace('rgb', 'rgba');
                                    ctx.fillRect(
                                        xAxis.getPixelForTick(splitIndex),
                                        yAxis.top,
                                        xAxis.getPixelForTick(chart.data.labels.length - 1) - xAxis.getPixelForTick(splitIndex),
                                        yAxis.bottom - yAxis.top
                                    );
                                    
                                    ctx.restore();
                                }
                            }
                        },
                        scales: {
                            x: { 
                                ticks: { 
                                    font: { 
                                        size: 8,
                                        color: (context) => {
                                            const index = context.index;
                                            return index < splitIndex ? prePostColors.PRE : prePostColors.POST;
                                        }
                                    } 
                                }, 
                                grid: { 
                                    display: false 
                                }
                            },
                            y: { 
                                grid: { 
                                    color: '#eee' 
                                }, 
                                min: niceMin, 
                                max: niceMax, 
                                ticks: { 
                                    stepSize: tickSpacing 
                                }, 
                                beginAtZero: maxVal < 10 
                            }
                        }
                    }
                };

                if (activeChartStyle) {
                    const style = activeChartStyle;
                    datasets.forEach(dataset => {
                        dataset.borderWidth = style.borderWidth;
                        dataset.pointRadius = style.pointRadius;
                        dataset.borderDash = style.borderDash;
                        dataset.tension = style.tension;
                        dataset.fill = style.fill;
                        if (style.fill && style.backgroundColor) {
                            dataset.backgroundColor = dataset.label.startsWith('PRE') ? 
                                prePostColors.PRE.replace(')', ', 0.1)').replace('rgb', 'rgba') :
                                prePostColors.POST.replace(')', ', 0.1)').replace('rgb', 'rgba');
                        }
                    });
                }

                try {
                    allCharts[fullKpiName] = new Chart(canvas.getContext("2d"), chartConfig);
                } catch (e) {
                    console.error(`Error creating chart for ${fullKpiName}:`, e);
                    const errorMsg = document.createElement("div");
                    errorMsg.style.textAlign = "center";
                    errorMsg.style.padding = "20px";
                    errorMsg.style.color = "#D24726";
                    errorMsg.textContent = "Error creating chart";
                    card.appendChild(errorMsg);
                }
            });
        }
        
        // --- KPI DRAWER FUNCTIONS ---
        function toggleDrawer(){
            const d = document.getElementById("kpiDrawer");
            d.classList.toggle("open");
            if(d.classList.contains("open")) populateKpiOptions();
        }

        function populateKpiOptions(){
            const list = document.getElementById("kpiOptionsList");
            list.innerHTML = "";
            let currentTech = "";

            kpiDefinitions.forEach(kpiDef => {
                const fullKpiName = kpiDef.tech + " - " + kpiDef.kpi;
                
                if (kpiDef.tech !== currentTech) {
                    list.innerHTML += `<div class="kpi-group-title">${kpiDef.tech} KPIs</div>`;
                    currentTech = kpiDef.tech;
                }

                const checked = selectedKpis.includes(fullKpiName) ? "checked" : "";
                const d = document.createElement("label");
                d.className = "kpi-option";
                d.innerHTML = `<input type='checkbox' value='${fullKpiName}' class='kpi-chk' ${checked}> ${kpiDef.kpi}`;
                d.onclick = (e) => {
                    const chk = d.querySelector("input");
                    if (e.target.tagName !== "INPUT") {
                        chk.checked = !chk.checked;
                    }
                };
                list.appendChild(d);
            });
        }
        
        function applyKpis() {
            const list = document.getElementById("kpiOptionsList");
            selectedKpis = Array.from(list.querySelectorAll(".kpi-chk:checked")).map(c => c.value);
            document.getElementById("kpiDrawer").classList.remove("open");
            
            renderCharts();
        }

        function selectVisibleKpis() {
            selectedKpis = kpiDefinitions.map(k => k.tech + " - " + k.kpi);
            populateKpiOptions();
        }
        
        function clearVisibleKpis() {
            selectedKpis = [];
            populateKpiOptions();
        }

        // --- CHART STYLING FUNCTIONS ---
        function toggleChartStyleDrawer(){
            const d = document.getElementById("chartStyleDrawer");
            d.classList.toggle("open");
        }

        function applyChartStyle(styleIndex){
            activeChartStyle = chartStyles[styleIndex];
            document.querySelectorAll('.style-button').forEach((btn, idx) => {
                if (idx === styleIndex) { 
                    btn.classList.add('active'); 
                } else { 
                    btn.classList.remove('active'); 
                }
            });
            
            updateColorButtons();
            
            renderCharts();
        }

        function updateColorButtons() {
            // Update tech color buttons
            const gsmBtn = document.querySelector('.tech-color-btn.gsm');
            const lteBtn = document.querySelector('.tech-color-btn.lte');
            
            if (gsmBtn) gsmBtn.style.background = techColors.GSM;
            if (lteBtn) lteBtn.style.background = techColors.LTE;
            
            // Update pre/post color buttons
            const preBtn = document.querySelector('.prepost-color-btn.pre');
            const postBtn = document.querySelector('.prepost-color-btn.post');
            
            if (preBtn) preBtn.style.background = prePostColors.PRE;
            if (postBtn) postBtn.style.background = prePostColors.POST;
        }

        // --- COLOR PICKER FUNCTIONS (FIXED) ---
        function openColorPicker(target) {
            selectedColorTarget = target;
            
            // Get the current color based on target
            if (target === 'GSM' || target === 'LTE') {
                selectedColor = techColors[target];
            } else if (target === 'PRE' || target === 'POST') {
                selectedColor = prePostColors[target];
            }
            
            document.getElementById('colorPickerTitle').textContent = `Select Color for ${target}`;
            
            const colorGrid = document.getElementById('colorPickerGrid');
            colorGrid.innerHTML = '';
            
            colorPalette.forEach(color => {
                const colorOption = document.createElement('div');
                colorOption.className = 'color-option';
                colorOption.style.backgroundColor = color;
                colorOption.dataset.color = color;
                
                if (color === selectedColor) {
                    colorOption.classList.add('selected');
                }
                
                colorOption.onclick = () => {
                    document.querySelectorAll('.color-option').forEach(opt => {
                        opt.classList.remove('selected');
                    });
                    colorOption.classList.add('selected');
                    selectedColor = color;
                };
                
                colorGrid.appendChild(colorOption);
            });
            
            document.getElementById('colorPickerModal').style.display = 'flex';
        }

        function closeColorPicker() {
            document.getElementById('colorPickerModal').style.display = 'none';
        }

        function applySelectedColor() {
            if (selectedColorTarget && selectedColor) {
                // Update the appropriate color variable
                if (selectedColorTarget === 'GSM' || selectedColorTarget === 'LTE') {
                    techColors[selectedColorTarget] = selectedColor;
                    
                    // Update KPI definitions
                    kpiDefinitions.forEach(kpi => {
                        if (kpi.tech === selectedColorTarget) {
                            kpi.color = selectedColor;
                        }
                    });
                } else if (selectedColorTarget === 'PRE' || selectedColorTarget === 'POST') {
                    prePostColors[selectedColorTarget] = selectedColor;
                }
                
                // Update UI buttons
                updateColorButtons();
                
                // Re-render charts with new colors
                renderCharts();
                
                closeColorPicker();
            }
        }

        // --- PPT EXPORT FUNCTIONS ---
        function openPPTExport() {
            const charts = document.querySelectorAll("canvas");
            if (charts.length === 0) {
                alert("No charts to export. Please select some KPIs first.");
                return;
            }
            
            const techOptions = document.getElementById('techExportOptions');
            techOptions.innerHTML = '';
            
            for (const tech in selectedTechForExport) {
                const div = document.createElement('div');
                div.className = 'tech-export-option';
                div.innerHTML = `
                    <input type="checkbox" id="export-${tech}" ${selectedTechForExport[tech] ? 'checked' : ''} 
                           onchange="updateTechExportSelection('${tech}', this.checked)">
                    <label for="export-${tech}">${tech}</label>
                `;
                techOptions.appendChild(div);
            }
            
            document.querySelectorAll('.graph-options button').forEach(btn => {
                if (parseInt(btn.dataset.count) === pptLayout) {
                    btn.classList.add('active');
                } else {
                    btn.classList.remove('active');
                }
            });
            
            updatePPTPreview(pptLayout);
            document.getElementById('pptModal').style.display = 'flex';
        }

        function closePPTExport() {
            document.getElementById('pptModal').style.display = 'none';
        }

        function updateTechExportSelection(tech, isSelected) {
            selectedTechForExport[tech] = isSelected;
            updatePPTPreview(pptLayout);
        }

        function updatePPTPreview(layoutCount) {
            pptLayout = layoutCount;
            
            document.querySelectorAll('.graph-options button').forEach(btn => {
                if (parseInt(btn.dataset.count) === layoutCount) {
                    btn.classList.add('active');
                } else {
                    btn.classList.remove('active');
                }
            });
            
            // Get ALL selected charts mixed together
            const allChartsForExport = [];
            const chartElements = document.querySelectorAll("canvas");
            
            chartElements.forEach((canvas, index) => {
                const chart = Chart.getChart(canvas.id);
                if (chart) {
                    const title = chart.options.plugins.title.text;
                    const tech = title.split(' - ')[0];
                    
                    if (selectedTechForExport[tech]) {
                        allChartsForExport.push({
                            canvas: canvas,
                            chart: chart,
                            title: title,
                            tech: tech
                        });
                    }
                }
            });
            
            if (allChartsForExport.length === 0) {
                document.getElementById('previewBody').innerHTML = 
                    '<div style="text-align:center;padding:40px;color:#666;">No charts selected for export.</div>';
                return;
            }
            
            const previewBody = document.getElementById('previewBody');
            previewBody.innerHTML = '';
            
            // Calculate grid layout based on selected layout
            const layout = getLayoutConfig(layoutCount);
            const gridTemplateCols = `repeat(${layout.cols}, 1fr)`;
            const gridTemplateRows = `repeat(${layout.rows}, 1fr)`;
            
            for (let i = 0; i < allChartsForExport.length; i += layoutCount) {
                const slideDiv = document.createElement('div');
                slideDiv.className = 'preview-slide';
                
                const slideTitle = document.createElement('div');
                slideTitle.className = 'preview-slide-title';
                slideTitle.textContent = `Slide ${Math.floor(i/layoutCount) + 1}`;
                slideDiv.appendChild(slideTitle);
                
                const grid = document.createElement('div');
                grid.className = 'preview-grid';
                grid.style.display = 'grid';
                grid.style.gridTemplateColumns = gridTemplateCols;
                grid.style.gridTemplateRows = gridTemplateRows;
                grid.style.gap = '10px';
                grid.style.height = '100%';
                grid.style.paddingTop = '30px';
                grid.style.alignContent = 'start';
                
                // Fill the grid
                for (let j = 0; j < layoutCount; j++) {
                    const cellIndex = i + j;
                    if (cellIndex < allChartsForExport.length) {
                        const chartData = allChartsForExport[cellIndex];
                        const box = createPreviewBox(chartData.canvas, chartData.title);
                        grid.appendChild(box);
                    } else {
                        // Empty cell for 1-0-0 layout
                        const emptyBox = document.createElement('div');
                        emptyBox.className = 'preview-img-box';
                        emptyBox.style.border = '1px dashed #eee';
                        emptyBox.style.background = '#f9f9f9';
                        emptyBox.innerHTML = '<div style="color:#999;font-size:12px;"></div>';
                        grid.appendChild(emptyBox);
                    }
                }
                
                slideDiv.appendChild(grid);
                previewBody.appendChild(slideDiv);
            }
        }

        function getLayoutConfig(count) {
            let rows, cols;
            switch(parseInt(count)) {
                case 1: rows = 1; cols = 1; break;
                case 2: rows = 1; cols = 2; break;
                case 3: rows = 2; cols = 2; break;
                case 4: rows = 2; cols = 2; break;
                case 6: rows = 2; cols = 3; break;
                case 9: rows = 3; cols = 3; break;
                default: rows = 3; cols = 3;
            }
            return { rows, cols };
        }

        function createPreviewBox(canvas, title) {
            const box = document.createElement('div');
            box.className = 'preview-img-box';
            
            try {
                const tempCanvas = document.createElement('canvas');
                tempCanvas.width = canvas.width;
                tempCanvas.height = canvas.height;
                const tempCtx = tempCanvas.getContext('2d');
                tempCtx.drawImage(canvas, 0, 0);
                const imgData = tempCanvas.toDataURL("image/png");
                
                const img = document.createElement('img');
                img.src = imgData;
                img.style.maxHeight = '100%';
                img.style.maxWidth = '100%';
                img.style.objectFit = 'contain';
                
                const titleLabel = document.createElement('div');
                titleLabel.textContent = title.length > 50 ? title.substring(0, 50) + '...' : title;
                titleLabel.style.fontSize = '12px';
                titleLabel.style.color = '#666';
                titleLabel.style.marginTop = '5px';
                titleLabel.style.textAlign = 'center';
                
                box.appendChild(img);
                box.appendChild(titleLabel);
            } catch (e) {
                box.innerHTML = '<div style="color:#D24726;font-size:12px;">Preview Error</div>';
            }
            
            return box;
        }

        async function downloadPPT() {
            const pptx = new PptxGenJS();
            pptx.layout = 'LAYOUT_16x9';
            
            // Title slide
            const titleSlide = pptx.addSlide();
            titleSlide.addText('KPI Dashboard Report - GSM/LTE', {
                x: 0.5, y: 1, w: 9, h: 1,
                fontSize: 36, bold: true, color: '2F80ED'
            });
            
            const date = new Date().toLocaleDateString();
            titleSlide.addText(`Generated: ${date}`, {
                x: 0.5, y: 2, w: 9, h: 0.5,
                fontSize: 16, color: '666666'
            });
            
            // Add filter information
            let filterText = isAllGroupsSelected ? 
                'All groups (aggregated)' : 
                `Group: ${selectedGroups[0]}`;
            titleSlide.addText(`Filter: ${filterText}`, {
                x: 0.5, y: 2.5, w: 9, h: 0.5,
                fontSize: 14, color: '666666'
            });
            
            // Get all selected charts mixed together
            const allChartsForExport = [];
            const chartElements = document.querySelectorAll("canvas");
            
            chartElements.forEach((canvas, index) => {
                const chart = Chart.getChart(canvas.id);
                if (chart) {
                    const title = chart.options.plugins.title.text;
                    const tech = title.split(' - ')[0];
                    
                    if (selectedTechForExport[tech]) {
                        allChartsForExport.push({
                            canvas: canvas,
                            chart: chart,
                            title: title,
                            tech: tech
                        });
                    }
                }
            });
            
            if (allChartsForExport.length === 0) {
                alert("No charts selected for export.");
                return;
            }
            
            // PPT layout calculations
            const layout = getLayoutConfig(pptLayout);
            const slideWidth = 10.0;
            const slideHeight = 5.625;
            const marginX = 0.5;
            const marginTop = 0.8;
            const marginBottom = 0.5;
            const gap = 0.2;
            
            const usableW = slideWidth - (marginX * 2);
            const usableH = slideHeight - marginTop - marginBottom;
            const chartW = (usableW - ((layout.cols - 1) * gap)) / layout.cols;
            const chartH = (usableH - ((layout.rows - 1) * gap)) / layout.rows;
            
            // Add chart slides
            for (let i = 0; i < allChartsForExport.length; i += pptLayout) {
                const slide = pptx.addSlide();
                
                // Add slide number
                slide.addText(`Slide ${Math.floor(i/pptLayout) + 1}`, {
                    x: 9.0, y: 0.1, w: 1, h: 0.3,
                    fontSize: 10, color: '999999'
                });
                
                for (let j = 0; j < pptLayout; j++) {
                    const chartIndex = i + j;
                    if (chartIndex < allChartsForExport.length) {
                        const chartData = allChartsForExport[chartIndex];
                        const rowIndex = Math.floor(j / layout.cols);
                        const colIndex = j % layout.cols;
                        
                        const xPos = marginX + (colIndex * (chartW + gap));
                        const yPos = marginTop + (rowIndex * (chartH + gap));
                        
                        try {
                            slide.addImage({
                                data: chartData.canvas.toDataURL("image/png"),
                                x: xPos,
                                y: yPos,
                                w: chartW,
                                h: chartH
                            });
                            
                            // Add chart title
                            const shortTitle = chartData.title.length > 40 ? 
                                chartData.title.substring(0, 40) + '...' : chartData.title;
                            slide.addText(shortTitle, {
                                x: xPos,
                                y: yPos - 0.25,
                                w: chartW,
                                h: 0.25,
                                fontSize: 7,
                                bold: true,
                                color: '333333'
                            });
                        } catch (e) {
                            console.error(`Error adding chart to PPT:`, e);
                        }
                    }
                }
            }
            
            // Summary slide
            const summarySlide = pptx.addSlide();
            summarySlide.addText('Summary', {
                x: 0.5, y: 0.5, w: 9, h: 0.5,
                fontSize: 28, bold: true, color: '2F80ED'
            });
            
            let summaryText = `Total Charts: ${allChartsForExport.length}\n`;
            summaryText += `Layout: ${layout.rows}x${layout.cols} (${pptLayout} per slide)\n`;
            summaryText += `Total Slides: ${Math.ceil(allChartsForExport.length / pptLayout) + 2}\n`;
            summaryText += `Group Filter: ${filterText}\n\n`;
            
            // Count by technology
            const techCount = {};
            allChartsForExport.forEach(chart => {
                techCount[chart.tech] = (techCount[chart.tech] || 0) + 1;
            });
            
            for (const tech in techCount) {
                summaryText += `${tech}: ${techCount[tech]} charts\n`;
            }
            
            summarySlide.addText(summaryText, {
                x: 0.5, y: 1.5, w: 9, h: 3,
                fontSize: 14, color: '333333'
            });
            
            // Download
            const timestamp = new Date().getTime();
            try {
                await pptx.writeFile({ fileName: `GSM_LTE_KPI_Report_${timestamp}.pptx` });
                closePPTExport();
            } catch (e) {
                alert("Error generating PPT: " + e.message);
            }
        }
    </script>
</body>
</html>

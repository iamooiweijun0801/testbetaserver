<!doctype html>
<html>
<head>
<meta charset="utf-8"/>
<title>Dynamic Batch Filter Map</title>
<meta name="viewport" content="width=device-width, initial-scale=1"/>
<link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css"/>

<style>
  body,html { margin:0; height:100%; font-family:Arial; }
  #app { display:grid; grid-template-columns:360px 1fr; height:100vh; }
  #panel { padding:12px; overflow:auto; background:#f2f5ff; }
  #map { height:100%; }
  .statbox { padding:12px; background:white; border-radius:8px; margin-bottom:8px; }
  select,input { padding:6px; width:100%; margin-bottom:10px; }
  button { width:100%; padding:10px; background:#0066ff; border:none; color:white; border-radius:8px; cursor:pointer; }
</style>

</head>
<body>

<div id="app">
  <div id="panel">
    <h2>Map Dashboard</h2>

    <label>Batch Filter</label>
    <select id="viewSelect"></select>

    <div class="statbox">
      <div><b>Done / Total:</b> <span id="doneTotal">0 / 0</span></div>
      <div><b>Pending:</b> <span id="pendingCount">0</span></div>
      <div><b>% Done:</b> <span id="donePct">0%</span></div>
    </div>

    <input id="searchInput" type="text" placeholder="Search eNodeB or Name"/>
    <button id="searchBtn">Search</button>

    <div id="details" style="padding:10px; background:white; border-radius:8px; min-height:40px;">
      Details appear here.
    </div>
  </div>

  <div id="map"></div>
</div>


<script src="https://unpkg.com/papaparse@5.4.1/papaparse.min.js"></script>
<script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>

<script>
/* --------------------------------------------------
   MAP SETUP
-------------------------------------------------- */
const map = L.map('map').setView([3, 101], 6);
L.tileLayer("https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png").addTo(map);
const markersLayer = L.layerGroup().addTo(map);

function dot(color){
  return L.divIcon({
    html:`<div style="width:12px;height:12px;background:${color};border:2px solid white;border-radius:50%"></div>`,
    className:"",
    iconSize:[12,12],
    iconAnchor:[6,6]
  });
}
const ICON_DONE = dot("#3aff00");
const ICON_PENDING = dot("#003d87");

/* --------------------------------------------------
   GLOBAL STORAGE
-------------------------------------------------- */
let allRows = [];
let visibleMarkers = {};
let pinnedMarker = null;

/* --------------------------------------------------
   CLEAN HELPERS
-------------------------------------------------- */
function escapeHtml(s){
  return String(s||"").replace(/&/g,"&amp;").replace(/</g,"&lt;");
}

function isDoneStatus(s){
  if(!s) return false;
  s = s.toLowerCase();
  return /done|on.?air|live|accepted|active/.test(s);
}

/* --------------------------------------------------
   BATCH FILTER DROPDOWN
-------------------------------------------------- */
function updateBatchFilterOptions(rows){
  const sel = document.getElementById("viewSelect");
  sel.innerHTML = "";

  const batches = [...new Set(rows.map(r => r.swap_batch).filter(Boolean))].sort();

  sel.appendChild(new Option("All Sites", "__ALL__"));

  batches.forEach(b => sel.appendChild(new Option(b, b)));
}

/* --------------------------------------------------
   MAIN RENDER FUNCTION (ALWAYS CALLED)
-------------------------------------------------- */
function renderFilteredRows(){
  const batch = document.getElementById("viewSelect").value;
  markersLayer.clearLayers();
  visibleMarkers = {};

  let rows = allRows;
  if(batch !== "__ALL__"){
    rows = rows.filter(r => (r.swap_batch||"") === batch);
  }

  let bounds = [];
  let done = 0, pending = 0;

  rows.forEach(r=>{
    if(!Number.isFinite(r.lat) || !Number.isFinite(r.lon)) return;

    const isDone = isDoneStatus(r.status);
    if(isDone) done++; else pending++;

    const marker = L.marker([r.lat, r.lon], {
      icon: isDone ? ICON_DONE : ICON_PENDING
    }).addTo(markersLayer);

    const popup = `
      <div><b>${escapeHtml(r.enodeb_name)}</b><br>
      ID: ${escapeHtml(r.enodeb_id)}<br>
      Batch: ${escapeHtml(r.swap_batch)}<br>
      Status: ${escapeHtml(r.status)}</div>
    `;

    marker.bindPopup(popup);
    visibleMarkers[r.enodeb_id] = marker;
    bounds.push([r.lat, r.lon]);

    marker.on("mouseover",()=>{ marker.openPopup(); });
    marker.on("click",()=>{ map.setView([r.lat,r.lon], 15); });
  });

  if(bounds.length){
    map.fitBounds(bounds, {padding:[40,40]});
  }

  document.getElementById("doneTotal").textContent = `${done} / ${rows.length}`;
  document.getElementById("pendingCount").textContent = pending;
  document.getElementById("donePct").textContent =
    rows.length ? Math.round(done/rows.length*100)+"%" : "0%";
}

/* --------------------------------------------------
   SEARCH FUNCTION
-------------------------------------------------- */
function searchAndZoom(term){
  term = (term||"").toLowerCase();

  const row = allRows.find(r =>
    r.enodeb_id.toLowerCase() === term ||
    r.site_name.toLowerCase().includes(term) ||
    r.enodeb_name.toLowerCase().includes(term)
  );

  if(!row){ alert("Not found."); return; }

  const batch = row.swap_batch || "__ALL__";
  document.getElementById("viewSelect").value = batch;
  renderFilteredRows();

  const m = visibleMarkers[row.enodeb_id];
  if(m){
    m.openPopup();
    map.setView(m.getLatLng(), 15);
  }

  document.getElementById("details").innerHTML =
    `<b>${row.enodeb_name}</b><br>ID: ${row.enodeb_id}`;
}

/* --------------------------------------------------
   LOAD CSV
-------------------------------------------------- */
function loadCsvText(text){
  const parsed = Papa.parse(text, {header:true, skipEmptyLines:true});
  allRows = parsed.data.map(r => ({
    enodeb_id: r.enodeb_id || "",
    enodeb_name: r.enodeb_name || r.site_name || "",
    site_name: r.site_name || "",
    swap_batch: r.swap_batch || "",
    status: r.status || "",
    lat: parseFloat((r.latitude||"").replace(",", ".")),
    lon: parseFloat((r.longitude||"").replace(",", "."))
  }));

  updateBatchFilterOptions(allRows);
  renderFilteredRows();
}

/* --------------------------------------------------
   FETCH LIVE CSV
-------------------------------------------------- */
const CSV_URL =
  "https://docs.google.com/spreadsheets/d/10UMN4MqTENsbHqdp2XdH7wDuNcbKtHdQhB3rKrd7fhg/export?format=csv";

async function fetchCsv(){
  try{
    const res = await fetch(CSV_URL);
    if(!res.ok) throw new Error();
    const text = await res.text();
    loadCsvText(text);
  }catch(e){
    alert("Cannot load CSV.");
  }
}

document.getElementById("searchBtn").onclick = ()=> searchAndZoom(document.getElementById("searchInput").value);
document.getElementById("viewSelect").onchange = renderFilteredRows;

fetchCsv();
</script>

</body>
</html>

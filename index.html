<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <title>KPI Dashboard</title>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/pptxgenjs@3.12.0/dist/pptxgen.bundle.js"></script>
    <style>
        /* --- BASE STYLES --- */
        body { font-family:'Segoe UI', Tahoma, Geneva, Verdana, sans-serif; margin:0; padding:0; background:#f4f7f6; overflow-x:hidden; }
        header { text-align:center; padding:15px 0; font-size:28px; font-weight:700; color:#333; background:white; box-shadow:0 2px 4px rgba(0,0,0,0.05); margin-bottom:15px; }

        /* --- CONTROLS --- */
        .controls { display:flex; justify-content:center; gap:10px; margin-bottom:20px; flex-wrap:wrap; align-items:center; }
        .control-group { position:relative; }
        button.action-btn { padding:8px 16px; cursor:pointer; border:none; background:#2F80ED; color:white; border-radius:6px; font-weight:600; transition:0.2s; }
        button.action-btn:hover { background:#1f5ab5; }
        button.ppt-btn { background:#D24726; }
        button.ppt-btn:hover { background:#a8381e; }

        /* --- TOGGLE SWITCH --- */
        .toggle-switch {
            display: flex;
            align-items: center;
            gap: 6px;
            font-size: 13px;
            cursor: pointer;
        }
        .toggle-switch .toggle-label {
            user-select: none;
        }
        .toggle-switch .switch {
            width: 50px;
            height: 24px;
            background: #ccc;
            border-radius: 12px;
            position: relative;
            transition: background 0.3s;
        }
        .toggle-switch .switch .circle {
            width: 20px;
            height: 20px;
            background: white;
            border-radius: 50%;
            position: absolute;
            top: 2px;
            left: 2px;
            transition: left 0.3s;
        }
        .toggle-switch.active .switch {
            background: #2F80ED;
        }
        .toggle-switch.active .switch .circle {
            left: 28px;
        }

        /* --- TECH FILTERS --- */
        .tech-filters { 
            display: flex; 
            gap: 5px; 
            margin: 0 10px;
        }
        .tech-filter-btn { 
            padding: 6px 12px; 
            border: 1px solid #ddd; 
            border-radius: 6px; 
            background: white; 
            cursor: pointer; 
            font-size: 12px; 
            font-weight: 600; 
            transition: 0.2s;
        }
        .tech-filter-btn.active { 
            background: #2F80ED; 
            color: white; 
            border-color: #2F80ED; 
        }
        .tech-filter-btn.gsm.active { background: #2F80ED; }
        .tech-filter-btn.lte.active { background: #27AE60; }
        .tech-filter-btn.nr.active { background: #D24726; }

        /* --- DROPDOWNS --- */
        #onAirDateDropdownList, #siteDropdownList { 
            position:absolute; 
            background:white; 
            border:1px solid #ccc; 
            max-height:200px; 
            overflow-y:auto; 
            display:none; 
            z-index:100; 
            width:100%; 
            top:105%; 
            border-radius:6px; 
            box-shadow:0 4px 10px rgba(0,0,0,0.1); 
        }
        #onAirDateDropdownList div, #siteDropdownList div { 
            padding:6px 10px; 
            cursor:pointer; 
            font-size:13px; 
            border-bottom:1px solid #eee; 
        }
        #onAirDateDropdownList div:hover, #siteDropdownList div:hover { 
            background:#f0f7ff; 
            color:#2F80ED; 
        }

        /* --- DRAWER TOGGLE BUTTONS --- */
        .drawer-toggle-buttons {
            position: fixed;
            top: 20px;
            right: 0;
            display: flex;
            flex-direction: column;
            gap: 8px;
            z-index: 900;
        }
        .chartStyleDrawerToggle, .kpiDrawerToggle {
            width: 36px;
            height: 36px;
            background: #8E44AD;
            color: white;
            border-radius: 6px 0 0 6px;
            cursor: pointer;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 20px;
            transition: 0.2s;
        }
        .kpiDrawerToggle {
            background: #2F80ED;
            margin-top: 8px;
        }
        .chartStyleDrawerToggle:hover, .kpiDrawerToggle:hover {
            opacity: 0.9;
        }

        /* --- GRID LAYOUT --- */
        .chart-grid { 
            display:grid; 
            grid-template-columns: repeat(3, 1fr); 
            gap:20px; 
            padding:0 20px 40px 20px; 
            max-width: 1800px; 
            margin: 0 auto; 
        }
        @media (max-width: 1400px) { .chart-grid { grid-template-columns: repeat(2, 1fr); } }
        @media (max-width: 768px) { .chart-grid { grid-template-columns: 1fr; } }

        /* --- CARDS & CHARTS --- */
        .chart-card { background:white; border-radius:8px; padding:15px; box-shadow:0 2px 8px rgba(0,0,0,0.08); display:flex; flex-direction:column; }
        .chart-container { position: relative; height: 280px; width: 100%; }

        /* --- DRAWERS --- */
        .chartStyleDrawer, .kpiDrawer {
            position: fixed; 
            top: 0; 
            right: 0;
            width: 320px;
            height: 100%; 
            background: white;
            box-shadow: -2px 0 10px rgba(0,0,0,0.1); 
            z-index: 1000;
            transform: translateX(100%); 
            transition: 0.3s; 
            padding: 20px;
            display: flex; 
            flex-direction: column;
        }
        .chartStyleDrawer.open, .kpiDrawer.open { 
            transform: translateX(0); 
        }
        .drawer-header { 
            display: flex; 
            justify-content: space-between; 
            align-items: center; 
            margin-bottom: 15px; 
            padding-bottom: 10px; 
            border-bottom: 1px solid #eee; 
        }
        .drawer-header h3 { margin: 0; }
        .drawer-controls { 
            display: flex; 
            gap: 5px;
            align-items: center; 
            margin-bottom: 15px;
        }
        .drawer-controls .action-btn { 
            padding: 6px 10px;
            font-size: 13px;
        }
        .kpi-options-body, .style-options-body { 
            flex-grow: 1; 
            overflow-y: auto; 
            padding-right: 5px; 
            padding-bottom: 40px; 
        }
        .style-button { 
            padding: 10px 12px; 
            margin: 6px 0; 
            background: #f5f5f5; 
            border-radius: 6px; 
            cursor: pointer; 
            font-weight: 500;
            border: 1px solid #ddd;
            transition: 0.2s;
        }
        .style-button:hover { 
            background: #e9e9e9; 
        }
        .style-button.active {
            background: #8E44AD;
            color: white;
            border-color: #8E44AD;
        }
        .kpi-group-title { 
            font-weight: bold; 
            color: #2F80ED; 
            margin-top: 15px; 
            margin-bottom: 5px; 
            border-bottom: 1px solid #eee; 
            padding-bottom: 3px; 
        }
        .kpi-option { 
            display: block; 
            margin-bottom: 5px; 
            cursor: pointer; 
            user-select: none; 
        }
        .kpi-option input[type="checkbox"] { 
            margin-right: 8px; 
        }

        /* --- PREVIEW MODAL --- */
        .modal { 
            position:fixed; 
            top:0; 
            left:0; 
            width:100%; 
            height:100%; 
            background:rgba(0,0,0,0.6); 
            z-index:2000; 
            display:none; 
            align-items:center; 
            justify-content:center; 
            backdrop-filter:blur(3px); 
        }
        .modal-content { 
            background:white; 
            width:95%; 
            max-width: 1400px; 
            height:90vh; 
            border-radius:12px; 
            display:flex; 
            flex-direction:column; 
            box-shadow:0 10px 25px rgba(0,0,0,0.3); 
        }
        .modal-header { 
            padding:15px 20px; 
            border-bottom:1px solid #eee; 
            display:flex; 
            justify-content:space-between; 
            align-items:center; 
            font-weight:bold; 
            font-size:18px; 
        }
        .modal-body { 
            flex:1; 
            display: flex; 
            padding:0; 
            overflow: hidden; 
        }
        #previewBody { 
            flex: 1; 
            overflow-y:auto; 
            padding:20px; 
            background:#f5f5f5; 
        }
        .preview-slide { 
            background:white; 
            border:1px solid #ddd; 
            margin-bottom:20px; 
            padding:20px; 
            box-shadow:0 2px 5px rgba(0,0,0,0.05); 
            aspect-ratio: 16/9; 
            position:relative; 
        }
        .preview-slide-title { 
            position:absolute; 
            top:10px; 
            left:20px; 
            font-size:16px; 
            font-weight:bold; 
            color:#D24726; 
        }
        .preview-grid { 
            display:grid; 
            height:100%; 
            align-items:center; 
            padding-top:30px; 
        }
        .preview-img-box { 
            text-align:center; 
            padding:5px; 
            height:100%; 
            display:flex; 
            flex-direction:column; 
            justify-content:center; 
        }
        .preview-img-box img { 
            max-width:100%; 
            max-height:calc(100% - 20px); 
            object-fit:contain; 
            border:1px solid #eee; 
        }
        #previewSettingsPanel {
            width: 250px;
            background: #fff;
            border-left: 1px solid #eee;
            padding: 20px;
            display: flex;
            flex-direction: column;
            flex-shrink: 0; 
        }
        .settings-group { 
            margin-bottom: 20px; 
        }
        .settings-group h4 { 
            margin-top: 0; 
            margin-bottom: 10px; 
            font-size: 14px; 
            color: #555; 
            border-bottom: 1px solid #eee; 
            padding-bottom: 5px; 
        }
        .graph-options button { 
            margin: 5px; 
            width: 100px; 
            padding: 6px; 
            font-size: 13px; 
            background: #f0f0f0;
            border: 1px solid #ddd;
            border-radius: 4px;
            cursor: pointer;
        }
        .graph-options button.active { 
            background: #2F80ED; 
            color: white; 
            border-color: #2F80ED; 
        }
        .tech-export-options { 
            display: flex; 
            flex-direction: column; 
            gap: 5px; 
        }
        .tech-export-option { 
            display: flex; 
            align-items: center; 
            gap: 8px; 
        }
        .tech-export-option input { 
            margin: 0; 
        }
        .modal-footer { 
            padding:15px 20px; 
            border-top:1px solid #eee; 
            text-align:right;
            flex-shrink: 0; 
        }

        /* --- LOADING STATE --- */
        .loading { 
            text-align: center; 
            padding: 40px; 
            color: #666; 
        }

        /* --- SITE INFO --- */
        .chart-site-info { 
            font-size: 12px; 
            color: #666; 
            margin-bottom: 10px; 
            padding: 5px 10px; 
            background: #f5f5f5; 
            border-radius: 4px; 
        }
    </style>
</head>
<body onload="initDashboard()">
    <header>KPI Dashboard</header>

    <div class="controls">
        <!-- On-Air Date Dropdown -->
        <div class="control-group" style="width:200px;">
            <button id="onAirDateDropdownBtn" class="action-btn" style="background:white; color:#333; border:1px solid #ccc; width:100%; text-align:left; display:flex; justify-content:space-between;">
                <span id="onAirDateBtnLabel">All On-Air Dates</span> <span>â–¼</span>
            </button>
            <div id="onAirDateDropdownList"></div>
        </div>

        <!-- Site Dropdown -->
        <div class="control-group" style="width:200px;">
            <button id="siteDropdownBtn" class="action-btn" style="background:white; color:#333; border:1px solid #ccc; width:100%; text-align:left; display:flex; justify-content:space-between;">
                <span id="siteBtnLabel">All Sites</span> <span>â–¼</span>
            </button>
            <div id="siteDropdownList"></div>
        </div>

        <!-- Technology Filters -->
        <div class="tech-filters" id="techFilters">
            <button class="tech-filter-btn gsm active" onclick="toggleTechFilter('GSM')">GSM</button>
            <button class="tech-filter-btn lte active" onclick="toggleTechFilter('LTE')">LTE</button>
            <button class="tech-filter-btn nr active" onclick="toggleTechFilter('NR')">NR</button>
        </div>

        <!-- Level Toggle Switch -->
        <div class="toggle-switch" id="levelToggle">
            <span class="toggle-label">Group Level</span>
            <div class="switch" onclick="switchLevel()">
                <div class="circle"></div>
            </div>
            <span class="toggle-label">Site Level</span>
        </div>

        <button onclick="fetchData()" class="action-btn">Refresh</button>
        <button onclick="openPPTExport()" class="action-btn ppt-btn">Export PPT</button>
    </div>

    <div class="chart-grid" id="mainChartContainer"></div>

    <!-- DRAWER TOGGLE BUTTONS -->
    <div class="drawer-toggle-buttons">
        <div class="chartStyleDrawerToggle" onclick="toggleChartStyleDrawer()">ðŸŽ¨</div>
        <div class="kpiDrawerToggle" onclick="toggleDrawer()">âš™</div>
    </div>

    <!-- CHART STYLE DRAWER -->
    <div id="chartStyleDrawer" class="chartStyleDrawer">
        <div class="drawer-header">
            <h3>Chart Styles</h3>
            <button onclick="toggleChartStyleDrawer()" style="border:none; background:none; font-size:22px; cursor:pointer;">âœ•</button>
        </div>
        <div class="style-options-body">
            <div class="style-button" onclick="applyChartStyle(0)">Style 1 â€“ Clean Lines</div>
            <div class="style-button" onclick="applyChartStyle(1)">Style 2 â€“ Bold</div>
            <div class="style-button" onclick="applyChartStyle(2)">Style 3 â€“ Dotted</div>
            <div class="style-button" onclick="applyChartStyle(3)">Style 4 â€“ Thick + Soft</div>
            <div class="style-button" onclick="applyChartStyle(4)">Style 5 â€“ Minimalist</div>
            <div class="style-button" onclick="applyChartStyle(5)">Style 6 â€“ Dashed</div>
            <div class="style-button" onclick="applyChartStyle(6)">Style 7 â€“ Neon</div>
            <div class="style-button" onclick="applyChartStyle(7)">Style 8 â€“ Shadow Line</div>
            <div class="style-button" onclick="applyChartStyle(8)">Style 9 â€“ Rounded Dots</div>
            <div class="style-button" onclick="applyChartStyle(9)">Style 10 â€“ Random Colors</div>
            
            <hr style="margin:15px 0;">
            
            <label><b>Custom Color:</b></label>
            <input type="color" id="customChartColor" onchange="applyCustomColor()" style="width:100%; height:40px; margin-top:6px;">
        </div>
    </div>

    <!-- KPI SETTINGS DRAWER -->
    <div id="kpiDrawer" class="kpiDrawer">
        <div class="drawer-header">
            <h3 id="drawerHeaderTitle">KPI Settings</h3>
            <button onclick="toggleDrawer()" style="border:none; background:none; font-size:24px; cursor:pointer; color:#777;">âœ•</button>
        </div>
        
        <div class="drawer-controls">
            <button class="action-btn" onclick="selectVisibleKpis()" style="background:#5cb85c;">Select All</button>
            <button class="action-btn" onclick="clearVisibleKpis()" style="background:#f0ad4e;">Clear All</button>
            <button class="action-btn" onclick="applyKpis()">Apply</button>
        </div>
        
        <div class="kpi-options-body" id="kpiOptionsList"></div>
    </div>

    <!-- PREVIEW MODAL -->
    <div id="pptModal" class="modal">
        <div class="modal-content">
            <div class="modal-header">
                <span>PPT Export Preview</span>
                <button onclick="closePPTExport()" style="border:none; background:none; font-size:20px; cursor:pointer;">âœ•</button>
            </div>
            <div class="modal-body">
                <div id="previewBody"></div>
                <div id="previewSettingsPanel">
                    <h3>Export Settings</h3>
                    <div class="settings-group">
                        <h4>Graphs per Slide</h4>
                        <div class="graph-options">
                            <button class="action-btn" data-count="1" onclick="updatePPTPreview(1)">1 Graph</button>
                            <button class="action-btn" data-count="2" onclick="updatePPTPreview(2)">2 Graphs</button>
                            <button class="action-btn" data-count="3" onclick="updatePPTPreview(3)">3 Graphs</button>
                            <button class="action-btn" data-count="4" onclick="updatePPTPreview(4)">4 Graphs</button>
                            <button class="action-btn" data-count="6" onclick="updatePPTPreview(6)">6 Graphs</button>
                            <button class="action-btn" data-count="9" onclick="updatePPTPreview(9)">9 Graphs</button>
                        </div>
                    </div>
                    <div class="settings-group">
                        <h4>Select Technologies</h4>
                        <div class="tech-export-options" id="techExportOptions"></div>
                    </div>
                </div>
            </div>
            <div class="modal-footer">
                <button class="action-btn" style="background:#888;" onclick="closePPTExport()">Cancel</button>
                <button class="action-btn ppt-btn" onclick="downloadPPT()">Download .PPTX</button>
            </div>
        </div>
    </div>

    <script>
        // --- CONFIG & STATE ---
        let allData = [];
        let allSites = [];
        let siteCutoverMap = {}; // Maps Site Name -> On-Air Date
        let allOnAirDates = [];
        let selectedOnAirDates = [];

        let selectedSites = [];
        let graphsPerSlide = 2; 
        
        let chartExportColor = '#2F80ED';
        let chartExportTitleColor = '#333333';
        
        let currentLevel = 'group'; // 'group' or 'site'
        const levelToggle = document.getElementById("levelToggle");

        const sheetConfig = {
            group: {
                GSM: "https://docs.google.com/spreadsheets/d/e/2PACX-1vRIeWBt5CB8zpdFja0b3h2kodVsUrjD_PSHOkF93MkecZF04gWDoMXVq-q0REU-RvFQbjVggJVDLpUi/pub?gid=1977848975&single=true&output=csv",
                LTE: "https://docs.google.com/spreadsheets/d/e/2PACX-1vRIeWBt5CB8zpdFja0b3h2kodVsUrjD_PSHOkF93MkecZF04gWDoMXVq-q0REU-RvFQbjVggJVDLpUi/pub?gid=893314169&single=true&output=csv",
                NR: "https://docs.google.com/spreadsheets/d/e/2PACX-1vRIeWBt5CB8zpdFja0b3h2kodVsUrjD_PSHOkF93MkecZF04gWDoMXVq-q0REU-RvFQbjVggJVDLpUi/pub?gid=1372365834&single=true&output=csv"
            },
            site: {
                GSM: "https://docs.google.com/spreadsheets/d/e/2PACX-1vRIeWBt5CB8zpdFja0b3h2kodVsUrjD_PSHOkF93MkecZF04gWDoMXVq-q0REU-RvFQbjVggJVDLpUi/pub?gid=1930867305&single=true&output=csv",
                LTE: "https://docs.google.com/spreadsheets/d/e/2PACX-1vRIeWBt5CB8zpdFja0b3h2kodVsUrjD_PSHOkF93MkecZF04gWDoMXVq-q0REU-RvFQbjVggJVDLpUi/pub?gid=0&single=true&output=csv",
                NR: "https://docs.google.com/spreadsheets/d/e/2PACX-1vRIeWBt5CB8zpdFja0b3h2kodVsUrjD_PSHOkF93MkecZF04gWDoMXVq-q0REU-RvFQbjVggJVDLpUi/pub?gid=1617739873&single=true&output=csv",
                cutover: "https://docs.google.com/spreadsheets/d/e/2PACX-1vRIeWBt5CB8zpdFja0b3h2kodVsUrjD_PSHOkF93MkecZF04gWDoMXVq-q0REU-RvFQbjVggJVDLpUi/pub?gid=19616562&single=true&output=csv"
            }
        };

        // KPI Definitions
        const kpiDefinitions = [
            { tech: "GSM", kpi: "Call setup success rate(%)", initialChecked: true, color: "#2F80ED" },
            { tech: "GSM", kpi: "Call drop rate(%)", initialChecked: true, color: "#2F80ED" },
            { tech: "GSM", kpi: "CS Traffic (erl)", initialChecked: true, color: "#2F80ED" },
            { tech: "LTE", kpi: "Call Setup Success Rate(%)", initialChecked: true, color: "#27AE60" },
            { tech: "LTE", kpi: "E-RAB Call Drop Rate(%)", initialChecked: true, color: "#27AE60" },
            { tech: "LTE", kpi: "DL -USER Average Throughput (Mbit/s)", initialChecked: true, color: "#27AE60" },
            { tech: "LTE", kpi: "UL -USER Average Throughput (Mbit/s)", initialChecked: true, color: "#27AE60" },
            { tech: "LTE", kpi: "DL Data Total Volume (Gbyte)", initialChecked: true, color: "#27AE60" },
            { tech: "LTE", kpi: "UL Data Total Volume (Gbyte)", initialChecked: true, color: "#27AE60" },
            { tech: "LTE", kpi: "DL PRB Utilization (%)", initialChecked: true, color: "#27AE60" },
            { tech: "NR", kpi: "SgNB Addition Success Rate (CU)(%)", initialChecked: true, color: "#D24726" },
            { tech: "NR", kpi: "DL Traffic Volume (GB)", initialChecked: true, color: "#D24726" },
            { tech: "NR", kpi: "DL User Throughput(Mbps)", initialChecked: true, color: "#D24726" },
        ];

        let selectedKpis = [];

        // Tech filters state
        let techFilters = { GSM: true, LTE: true, NR: true };

        // Chart Styling
        let activeChartStyle = null;
        let activeCustomColor = null;

        const chartStyles = [
            { borderWidth: 2, pointRadius: 3, borderDash: [], tension: 0.2, borderColor: null },
            { borderWidth: 4, pointRadius: 5, borderDash: [], tension: 0.25, borderColor: null },
            { borderWidth: 2, pointRadius: 0, borderDash: [6,3], tension: 0.1, borderColor: null },
            { borderWidth: 3, pointRadius: 4, borderDash: [], tension: 0.4, borderColor: null },
            { borderWidth: 1, pointRadius: 0, borderDash: [], tension: 0, borderColor: null },
            { borderWidth: 2, pointRadius: 2, borderDash: [4,4], tension: 0.3, borderColor: null },
            { borderWidth: 3, pointRadius: 6, borderDash: [], tension: 0.15, borderColor: null },
            { borderWidth: 3, pointRadius: 3, borderDash: [], tension: 0.2, borderColor: null },
            { borderWidth: 2, pointRadius: 8, borderDash: [], tension: 0.25, borderColor: null },
            { borderWidth: 3, pointRadius: 5, borderDash: [], tension: 0.25, randomColor: true }
        ];

        // PPT Export
        let pptLayout = 9;
        let selectedTechForExport = { GSM: true, LTE: true, NR: true };

        // --- GLOBAL UTILITY FUNCTIONS ---
        function switchLevel() {
            if(currentLevel === 'site') {
                currentLevel = 'group';
                levelToggle.classList.remove('active');
            } else {
                currentLevel = 'site';
                levelToggle.classList.add('active');
            }
            fetchData();
        }

        function toggleTechFilter(tech) {
            techFilters[tech] = !techFilters[tech];
            const btn = document.querySelector(`.tech-filter-btn.${tech.toLowerCase()}`);
            btn.classList.toggle('active', techFilters[tech]);
            
            // Update site dropdown when tech filters change
            setupSiteDropdown();
            fetchData();
        }

        // --- DATA FETCHING & MAPPING ---
        async function fetchData(){
            try {
                // 1. Fetch KPI Data
                const sheetUrls = currentLevel === 'group' ? sheetConfig.group : sheetConfig.site;
                
                // Clear previous data
                allData = [];
                allSites = [];
                
                // Fetch data for each enabled technology
                for (const tech in sheetUrls) {
                    if (tech === 'cutover' || !techFilters[tech]) continue;
                    
                    try {
                        const kpiUrl = sheetUrls[tech] + "&t=" + Date.now();
                        const kpiRes = await fetch(kpiUrl);
                        const kpiText = await kpiRes.text();
                        
                        const kpiRows = kpiText.trim().split('\n').map(r=>r.split(','));
                        const kpiHeaders = kpiRows.shift().map(h=>h.trim());
                        
                        kpiRows.forEach(r=>{ 
                            const obj={}; 
                            kpiHeaders.forEach((h,i)=>{ 
                                const val=r[i]?r[i].trim():""; 
                                obj[h] = val==="" ? null : (isNaN(val) ? val : parseFloat(val)); 
                            }); 
                            
                            // Add technology info
                            obj.Tech = tech;
                            
                            // Determine site name based on technology
                            if (tech === 'GSM') {
                                obj.SiteName = obj["BSC Name"] || obj["Site Name"] || '';
                            } else if (tech === 'LTE') {
                                obj.SiteName = obj["eNodeB Name"] || obj["Site Name"] || '';
                            } else if (tech === 'NR') {
                                obj.SiteName = obj["gNodeB Name"] || obj["Site Name"] || '';
                            }
                            
                            allData.push(obj);
                            
                            // Collect sites
                            if (obj.SiteName && !allSites.includes(obj.SiteName)) {
                                allSites.push(obj.SiteName);
                            }
                        });
                    } catch(e) { 
                        console.error(`Error loading ${tech} data:`, e); 
                    }
                }

                // 2. Fetch Cutover Data
                const cutoverUrl = sheetConfig.site.cutover + "&t=" + Date.now();
                const cutoverRes = await fetch(cutoverUrl);
                const cutoverText = await cutoverRes.text();
                
                const cutoverRows = cutoverText.trim().split('\n').map(r=>r.split(','));
                const cutoverHeaders = cutoverRows.shift().map(h=>h.trim());
                
                siteCutoverMap = {};
                cutoverRows.forEach(r => {
                    // NR is also called eNodeB Name in cutover sheet
                    const siteName = r[cutoverHeaders.indexOf("eNodeB Name")]?.trim();
                    const onAirDate = r[cutoverHeaders.indexOf("On-Air Date")]?.trim();
                    
                    if (siteName && onAirDate) {
                        // Check if this site exists in our data
                        if (allSites.includes(siteName)) {
                            siteCutoverMap[siteName] = onAirDate;
                        }
                        
                        // Also check for GSM sites (GBSC)
                        const gbscName = r[cutoverHeaders.findIndex(h => h.includes("GBSC"))]?.trim();
                        if (gbscName && allSites.includes(gbscName)) {
                            siteCutoverMap[gbscName] = onAirDate;
                        }
                    }
                });

                // 3. Initialize Date Filter Options and State
                allOnAirDates = [...new Set(Object.values(siteCutoverMap))].filter(d => d).sort();
                selectedOnAirDates = [...allOnAirDates]; // Default: Select All Dates
                
                // For site level: if no sites selected, select all sites from selected dates
                if (currentLevel === 'site') {
                    selectedSites = allSites.filter(site => {
                        const date = siteCutoverMap[site];
                        return date && selectedOnAirDates.includes(date);
                    });
                } else {
                    // For group level, don't filter by site
                    selectedSites = [];
                }

                // 4. Update UI
                setupOnAirDateDropdown();
                setupSiteDropdown();
                renderCharts();

            } catch(e) { 
                console.error(e); 
                document.getElementById("mainChartContainer").innerHTML = 
                    `<div class='loading' style='color:#D24726;'>Error loading data: ${e.message}</div>`;
            }
        }

        // --- FILTER UI LOGIC (ON-AIR DATE) ---
        function setupOnAirDateDropdown(){
            const list = document.getElementById("onAirDateDropdownList");
            const btn = document.getElementById("onAirDateDropdownBtn");
            list.innerHTML = "";
            
            const setAll = () => { 
                selectedOnAirDates = [...allOnAirDates]; 
                if (currentLevel === 'site') {
                    // Select all sites from selected dates
                    selectedSites = allSites.filter(site => {
                        const date = siteCutoverMap[site];
                        return date && selectedOnAirDates.includes(date);
                    });
                }
                updateDateFilterUI({close: false}); 
                setupSiteDropdown();
                fetchData();
            };

            const clearAll = () => { 
                selectedOnAirDates = []; 
                selectedSites = []; 
                updateDateFilterUI({close: false}); 
                setupSiteDropdown(); 
                fetchData();
            };
            
            // Actions
            list.innerHTML += `<div onclick="window.dateSetAll()"><b>Select All</b></div>`;
            list.innerHTML += `<div onclick="window.dateClearAll()"><b>Clear All</b></div>`;

            // Options
            allOnAirDates.forEach(date => {
                const d = document.createElement("div");
                const checked = selectedOnAirDates.includes(date) ? "checked" : "";
                d.innerHTML = `<input type='checkbox' value='${date}' class='date-chk' ${checked}> ${date}`;
                d.onclick = (e) => {
                    if(e.target.tagName !== "INPUT") {
                        const chk = d.querySelector("input");
                        chk.checked = !chk.checked;
                    }
                    updateSelectedDates();
                };
                list.appendChild(d);
            });
            
            btn.onclick = () => list.style.display = list.style.display==="block" ? "none" : "block";
            
            window.dateSetAll = setAll;
            window.dateClearAll = clearAll;
            updateDateFilterUI({close: true});
        }

        function updateSelectedDates() {
            const list = document.getElementById("onAirDateDropdownList");
            selectedOnAirDates = Array.from(list.querySelectorAll(".date-chk:checked")).map(c => c.value);
            
            if (currentLevel === 'site') {
                // Filter sites by selected dates
                let activeSites = allSites.filter(site => {
                    const date = siteCutoverMap[site];
                    return date && selectedOnAirDates.includes(date);
                });
                selectedSites = [...activeSites]; 
            }
            
            updateDateFilterUI({close: false}); 
            setupSiteDropdown(); 
            fetchData();
        }

        function updateDateFilterUI(options = {close: true}) {
            const btn = document.getElementById("onAirDateDropdownBtn");
            const span = document.getElementById("onAirDateBtnLabel");
            const list = document.getElementById("onAirDateDropdownList");
            
            span.textContent = selectedOnAirDates.length === 0 ? "No Dates Selected" : 
                (selectedOnAirDates.length === allOnAirDates.length ? "All On-Air Dates" : `Selected (${selectedOnAirDates.length})`);
            
            list.querySelectorAll(".date-chk").forEach(c => c.checked = selectedOnAirDates.includes(c.value));
            
            if (options.close) {
                list.style.display = "none";
            } else {
                list.style.display = "block";
            }
        }

        // --- FILTER UI LOGIC (Site Name) ---
        function setupSiteDropdown(){
            const list = document.getElementById("siteDropdownList");
            const btn = document.getElementById("siteDropdownBtn");
            list.innerHTML = "";

            let activeSites = allSites.filter(site => {
                const date = siteCutoverMap[site];
                return date && selectedOnAirDates.includes(date);
            });
            
            // Filter by technology
            activeSites = activeSites.filter(site => {
                // Determine technology based on site name or data
                const siteData = allData.find(d => d.SiteName === site);
                if (siteData) {
                    return techFilters[siteData.Tech];
                }
                return true; // If no data, include it
            });
            
            // For site level, maintain selection
            if (currentLevel === 'site') {
                selectedSites = selectedSites.filter(site => activeSites.includes(site));
            } else {
                // For group level, don't filter by site
                selectedSites = [];
            }
            
            const setAll = () => { 
                selectedSites = [...activeSites]; 
                updateSiteFilterUI({close: false}); 
                fetchData();
            }; 

            const clearAll = () => { 
                selectedSites = []; 
                updateSiteFilterUI({close: false}); 
                fetchData(); 
            };
            
            list.innerHTML += `<div onclick="window.siteSetAll()"><b>Select All (${activeSites.length})</b></div>`;
            list.innerHTML += `<div onclick="window.siteClearAll()"><b>Clear All</b></div>`;

            activeSites.forEach(site => {
                const d = document.createElement("div");
                const checked = selectedSites.includes(site) ? "checked" : ""; 
                d.innerHTML = `<input type='checkbox' value='${site}' class='site-chk' ${checked}> ${site}`;
                d.onclick = (e) => {
                    if(e.target.tagName !== "INPUT") {
                        const chk = d.querySelector("input");
                        chk.checked = !chk.checked;
                    }
                    updateSelectedSites();
                };
                list.appendChild(d);
            });
            
            btn.onclick = () => list.style.display = list.style.display==="block" ? "none" : "block";

            window.siteSetAll = setAll;
            window.siteClearAll = clearAll;
            
            updateSiteFilterUI({close: true});
        }

        function updateSelectedSites() {
            const list = document.getElementById("siteDropdownList");
            selectedSites = Array.from(list.querySelectorAll(".site-chk:checked")).map(c => c.value);
            updateSiteFilterUI({close: false});
            fetchData();
        }

        function updateSiteFilterUI(options = {close: true}) {
            const btn = document.getElementById("siteDropdownBtn");
            const span = document.getElementById("siteBtnLabel");
            const list = document.getElementById("siteDropdownList");
            
            let activeSites = allSites.filter(site => {
                const date = siteCutoverMap[site];
                return selectedOnAirDates.includes(date);
            });

            if(currentLevel === 'group') {
                span.textContent = "All Sites";
            } else if(selectedSites.length === 0) {
                span.textContent = "All Active Sites";
            } else if(selectedSites.length === activeSites.length) {
                span.textContent = `All Active Sites (${selectedSites.length})`;
            } else if(selectedSites.length === 1) {
                span.textContent = selectedSites[0];
            } else {
                span.textContent = `Selected (${selectedSites.length})`;
            }

            list.querySelectorAll(".site-chk").forEach(c => c.checked = selectedSites.includes(c.value));
            
            if (options.close) {
                list.style.display = "none";
            } else {
                list.style.display = "block";
            }
        }

        // --- CHART RENDERING ---
        function renderCharts(){
            const container = document.getElementById("mainChartContainer");
            container.innerHTML = "";
            
            if (allData.length === 0) {
                container.innerHTML = "<div class='loading'>No data available</div>";
                return;
            }
            
            // Filter KPI definitions based on selected KPIs
            const chartsToRender = kpiDefinitions.filter(k => {
                return selectedKpis.includes(k.tech + " - " + k.kpi) && techFilters[k.tech];
            });
            
            if (chartsToRender.length === 0) {
                container.innerHTML = "<div class='loading'>No KPIs selected. Please select KPIs from settings.</div>";
                return;
            }

            // Filter data based on selections
            let filteredData = allData;
            
            // For site level, filter by selected sites
            if (currentLevel === 'site' && selectedSites.length > 0) {
                filteredData = allData.filter(d => selectedSites.includes(d.SiteName));
            }
            
            // Also filter by technology
            filteredData = filteredData.filter(d => techFilters[d.Tech]);

            if (filteredData.length === 0) {
                container.innerHTML = "<div class='loading'>No data available with current filters</div>";
                return;
            }

            // Get timeline
            const dateHeader = Object.keys(filteredData[0] || {}).find(h => h.toLowerCase().includes('date'));
            if (!dateHeader) {
                container.innerHTML = "<div class='loading' style='color:#D24726;'>Error: No date column found</div>";
                return;
            }

            const timeline = [...new Set(filteredData.map(d=>d[dateHeader]))].filter(d => d).sort((a,b)=>{
                const [da,ma,ya]=a.split('/').map(Number);
                const [db,mb,yb]=b.split('/').map(Number);
                return new Date(ya,ma-1,da)-new Date(yb,mb-1,db);
            });

            if (timeline.length === 0) {
                container.innerHTML = "<div class='loading'>No timeline data available</div>";
                return;
            }

            const monthNames = ["Jan", "Feb", "Mar", "Apr", "May", "Jun", "Jul", "Aug", "Sep", "Oct", "Nov", "Dec"];
            const timelineLabels = timeline.map(d => {
                const [day, month] = d.split('/').map(Number);
                return `${day} ${monthNames[month - 1]}`;
            });

            chartsToRender.forEach((kpiDef, idx) => {
                const fullKpiName = kpiDef.tech + " - " + kpiDef.kpi;
                const tech = kpiDef.tech;
                const kpi = kpiDef.kpi;

                const card = document.createElement("div");
                card.className = "chart-card";
                
                // Add site info for site level
                if (currentLevel === 'site' && selectedSites.length > 0) {
                    const siteInfo = document.createElement("div");
                    siteInfo.className = "chart-site-info";
                    siteInfo.textContent = `Sites: ${selectedSites.length} selected`;
                    card.appendChild(siteInfo);
                }
                
                const wrapper = document.createElement("div");
                wrapper.className = "chart-container";
                
                const canvas = document.createElement("canvas");
                canvas.id = `chart_${idx}`;
                
                wrapper.appendChild(canvas);
                card.appendChild(wrapper);
                container.appendChild(card);

                // Calculate data points
                const dataPoints = timeline.map(date => {
                    const values = filteredData
                        .filter(d => d.Tech === tech && d[dateHeader] === date)
                        .map(d => d[kpi])
                        .filter(v => v !== null && v !== "")
                        .map(Number)
                        .filter(v => !isNaN(v));

                    if (values.length === 0) return null;

                    const kpiLower = kpi.toLowerCase();
                    if (
                        kpiLower.includes('%') ||
                        kpiLower.includes('rate') ||
                        kpiLower.includes('avg') ||
                        kpiLower.includes('average')
                    ) {
                        return values.reduce((a, b) => a + b, 0) / values.length;
                    } else {
                        return values.reduce((a, b) => a + b, 0);
                    }
                });

                // Only valid values
                let validValues = dataPoints.filter(v => v !== null);
                if (validValues.length === 0) {
                    card.innerHTML = `<div class='loading'>No ${tech} data available</div>`;
                    return;
                }

                let minVal = Math.min(...validValues);
                let maxVal = Math.max(...validValues);

                // Compute smart Y-axis
                const { niceMin, niceMax, tickSpacing } = computeYAxis(minVal, maxVal);

                // Chart Color
                let chartColor;
                if (activeCustomColor) {
                    chartColor = activeCustomColor;
                } else if (activeChartStyle && activeChartStyle.randomColor) {
                    chartColor = getRandomColor();
                } else if (activeChartStyle && activeChartStyle.borderColor) {
                    chartColor = activeChartStyle.borderColor;
                } else {
                    chartColor = kpiDef.color || getRandomColor();
                }

                // Chart Config
                const chartConfig = {
                    type: 'line',
                    data: {
                        labels: timelineLabels,
                        datasets: [{
                            label: (currentLevel === 'site' && selectedSites.length > 0 && dataPoints.some(p => p !== null)) ? "Aggregate" : "No Data",
                            data: dataPoints,
                            borderColor: chartColor,
                            backgroundColor: 'transparent',
                            borderWidth: 2,
                            pointRadius: 3,
                            tension: 0.1,
                            spanGaps: true
                        }]
                    },
                    options: {
                        responsive: true,
                        maintainAspectRatio: false,
                        animation: {
                            x: {
                                type: 'number',
                                easing: 'linear',
                                duration: 500,
                                from: NaN,
                                delay: (ctx) => ctx.index * 30
                            },
                            y: { duration: 0 }
                        },
                        plugins: {
                            legend: { display: false },
                            title: {
                                display: true,
                                text: kpi,
                                font: { size: 14, weight: 'bold' },
                                color: '#333'
                            }
                        },
                        scales: {
                            x: {
                                ticks: { font: { size: 8 } },
                                grid: { display: false }
                            },
                            y: {
                                grid: { color: '#eee' },
                                min: niceMin,
                                max: niceMax,
                                ticks: { stepSize: tickSpacing },
                                beginAtZero: maxVal < 10
                            }
                        }
                    }
                };

                // Apply active chart style if set
                if (activeChartStyle) {
                    const style = activeChartStyle;
                    chartConfig.data.datasets[0].borderWidth = style.borderWidth;
                    chartConfig.data.datasets[0].pointRadius = style.pointRadius;
                    chartConfig.data.datasets[0].borderDash = style.borderDash;
                    chartConfig.data.datasets[0].tension = style.tension;
                    
                    if (!activeCustomColor && !style.randomColor && style.borderColor) {
                        chartConfig.data.datasets[0].borderColor = style.borderColor;
                    }
                }

                // Create chart
                try {
                    new Chart(canvas.getContext("2d"), chartConfig);
                } catch (e) {
                    console.error(`Chart error ${fullKpiName}:`, e);
                    card.innerHTML = `<div class='loading' style='color:#D24726;'>Error creating chart</div>`;
                }
            });
        }

        function computeYAxis(minVal, maxVal) {
            // Special rule: if min >= 98 and max <= 100
            if (minVal >= 97 && maxVal <= 100) {
                return { niceMin: 96, niceMax: 100, tickSpacing: 1 };
            }

            // Â±5% buffer
            let minV = minVal * 0.95;
            let maxV = maxVal * 1.05;

            // Small KPI rule
            if (maxVal < 10) minV = 0;

            // Cap 90â€“100 â†’ ymax = 100
            if (maxVal > 90 && maxVal <= 100) maxV = 100;

            let range = maxV - minV;
            if (range === 0) range = Math.abs(maxV) * 0.1 || 1;

            // Choose nice tick spacing
            const tickSpacing = niceNumber(range / 5, true);

            // Align min/max to nice numbers
            const niceMin = Math.floor(minV / tickSpacing) * tickSpacing;
            const niceMax = Math.ceil(maxV / tickSpacing) * tickSpacing;

            return { niceMin, niceMax, tickSpacing };
        }

        function niceNumber(value, round) {
            const exponent = Math.floor(Math.log10(value));
            const fraction = value / Math.pow(10, exponent);

            let niceFraction;
            if (round) {
                if (fraction < 1.5) niceFraction = 1;
                else if (fraction < 3) niceFraction = 2;
                else if (fraction < 7) niceFraction = 5;
                else niceFraction = 10;
            } else {
                if (fraction <= 1) niceFraction = 1;
                else if (fraction <= 2) niceFraction = 2;
                else if (fraction <= 5) niceFraction = 5;
                else niceFraction = 10;
            }

            return niceFraction * Math.pow(10, exponent);
        }

        function getRandomColor() {
            const colors = ['#2F80ED', '#27AE60', '#D24726', '#8E44AD', '#F39C12', '#2980B9'];
            return colors[Math.floor(Math.random() * colors.length)];
        }

        // --- DRAWER FUNCTIONS ---
        function toggleDrawer(){
            const d = document.getElementById("kpiDrawer");
            d.classList.toggle("open");
            if(d.classList.contains("open")) populateKpiOptions();
        }

        function toggleChartStyleDrawer(){
            const d = document.getElementById("chartStyleDrawer");
            d.classList.toggle("open");
        }

        // --- CHART STYLING FUNCTIONS ---
        function applyChartStyle(styleIndex){
            activeChartStyle = chartStyles[styleIndex];
            
            document.querySelectorAll('.style-button').forEach((btn, idx) => {
                if (idx === styleIndex) {
                    btn.classList.add('active');
                } else {
                    btn.classList.remove('active');
                }
            });
            
            renderCharts();
        }

        function applyCustomColor(){
            activeCustomColor = document.getElementById("customChartColor").value;
            renderCharts();
        }

        // --- KPI DRAWER FUNCTIONS ---
        function populateKpiOptions(){
            const list = document.getElementById("kpiOptionsList");
            list.innerHTML = "";
            
            document.getElementById('drawerHeaderTitle').textContent = 'KPI Settings';

            let currentTech = "";
            kpiDefinitions.forEach(kpiDef => {
                if (kpiDef.tech !== currentTech) {
                    list.innerHTML += `<div class="kpi-group-title">${kpiDef.tech} KPIs</div>`;
                    currentTech = kpiDef.tech;
                }
                
                const fullKpiName = kpiDef.tech + " - " + kpiDef.kpi;
                const checked = selectedKpis.includes(fullKpiName) ? "checked" : "";
                const div = document.createElement("div");
                div.innerHTML = `<input type='checkbox' class='kpi-chk' value='${fullKpiName}' ${checked}> <span style='font-size:13px'>${kpiDef.kpi}</span>`;
                div.onclick = (e) => {
                    if(e.target.tagName !== "INPUT") {
                        const chk = div.querySelector("input");
                        chk.checked = !chk.checked;
                    }
                };
                list.appendChild(div);
            });
        }

        function selectVisibleKpis() {
            selectedKpis = kpiDefinitions.map(k => k.tech + " - " + k.kpi);
            populateKpiOptions();
        }

        function clearVisibleKpis() {
            selectedKpis = [];
            populateKpiOptions();
        }

        function applyKpis(){
            const chks = document.querySelectorAll(".kpi-chk");
            selectedKpis = Array.from(chks).filter(c => c.checked).map(c => c.value);
            
            toggleDrawer();
            renderCharts();
        }

        // --- PPT EXPORT ---
        function getLayoutConfig(count) {
            const slideWidth = 10.0;
            const slideHeight = 5.625;
            
            const marginX = 0.2;	
            const marginTop = 0.9;
            const marginBottom = 0.2;
            const gap = 0.15;

            let rows, cols;

            switch(parseInt(count)) {
                case 1: rows = 1; cols = 1; break;
                case 2: rows = 1; cols = 2; break;
                case 3: rows = 2; cols = 2; break;
                case 4: rows = 2; cols = 2; break;
                case 6: rows = 2; cols = 3; break;
                case 9: rows = 3; cols = 3; break;
                default: rows = 2; cols = 2;
            }

            const usableW = slideWidth - (marginX * 2);
            const usableH = slideHeight - marginTop - marginBottom;

            const chartW = (usableW - ((cols - 1) * gap)) / cols;
            const chartH = (usableH - ((rows - 1) * gap)) / rows;

            return { rows, cols, chartW, chartH, gap, marginX, marginTop, slideWidth, slideHeight };
        }

        function openPPTExport() {
            const canvases = document.querySelectorAll("canvas");
            if(canvases.length === 0) { 
                alert("No charts to export."); 
                return; 
            }
            
            // Setup tech export options
            const techOptions = document.getElementById('techExportOptions');
            techOptions.innerHTML = '';
            for (const tech in selectedTechForExport) {
                techOptions.innerHTML += `
                    <div class="tech-export-option">
                        <input type="checkbox" id="export-${tech}" ${selectedTechForExport[tech] ? 'checked' : ''} onchange="updateTechExportSelection('${tech}', this.checked)">
                        <label for="export-${tech}">${tech}</label>
                    </div>
                `;
            }
            
            // Highlight active layout button
            document.querySelectorAll('.graph-options button').forEach(btn => {
                btn.classList.toggle('active', parseInt(btn.dataset.count) === pptLayout);
            });
            
            updatePPTPreview(pptLayout);
            document.getElementById("pptModal").style.display = "flex";
        }

        function closePPTExport() { 
            document.getElementById("pptModal").style.display = "none"; 
        }

        function updateTechExportSelection(tech, isSelected) {
            selectedTechForExport[tech] = isSelected;
            updatePPTPreview(pptLayout);
        }

        function updatePPTPreview(layoutCount) {
            pptLayout = layoutCount;
            
            // Highlight active layout button
            document.querySelectorAll('.graph-options button').forEach(btn => {
                btn.classList.toggle('active', parseInt(btn.dataset.count) === layoutCount);
            });
            
            const body = document.getElementById("previewBody");
            const canvases = document.querySelectorAll("canvas");
            
            document.getElementById("previewTitle").textContent = `PPT Export Preview (${layoutCount} Graphs per Slide)`;
            body.innerHTML = "";

            const layout = getLayoutConfig(layoutCount);
            const gridTemplateCols = `repeat(${layout.cols}, 1fr)`;

            for(let i=0; i<canvases.length; i+=layoutCount){
                const slideDiv = document.createElement("div");
                slideDiv.className = "preview-slide";
                
                const slideTitle = document.createElement("div");
                slideTitle.className = "preview-slide-title";
                slideTitle.textContent = `Slide ${Math.floor(i/layoutCount) + 1}`;
                slideDiv.appendChild(slideTitle);

                const grid = document.createElement("div");
                grid.className = "preview-grid";
                grid.style.display = "grid";
                grid.style.gridTemplateColumns = gridTemplateCols;
                grid.style.gap = "10px";
                grid.style.height = "100%";
                grid.style.paddingTop = "30px";
                grid.style.alignContent = "start";

                for(let j=0; j<layoutCount; j++){
                    if(i+j < canvases.length){
                        const c = canvases[i+j];
                        const box = createPreviewBox(c);	
                        grid.appendChild(box);
                    }
                }
                slideDiv.appendChild(grid);
                body.appendChild(slideDiv);
            }
        }

        function createPreviewBox(canvas) {
            const box = document.createElement("div");
            box.className = "preview-img-box";
            
            const tempCanvas = document.createElement('canvas');
            tempCanvas.width = canvas.width;
            tempCanvas.height = canvas.height;
            const tempCtx = tempCanvas.getContext('2d');
            tempCtx.drawImage(canvas, 0, 0);
            
            const img = document.createElement("img");
            img.src = tempCanvas.toDataURL("image/png");
            img.style.maxHeight = "100%";
            img.style.maxWidth = "100%";
            img.style.objectFit = "contain";
            
            box.appendChild(img);
            return box;
        }

        async function downloadPPT(){
            const pptx = new PptxGenJS();
            pptx.layout = 'LAYOUT_16x9';
            
            // Title slide
            let slide = pptx.addSlide();
            slide.addText("KPI Dashboard Report", { x:0.5, y:2, fontSize:32, bold:true, color:'2F80ED' });
            slide.addText(`Generated: ${new Date().toLocaleDateString()}`, { x:0.5, y:3, fontSize:14 });

            const canvases = document.querySelectorAll("canvas");
            const count = pptLayout;
            
            const layout = getLayoutConfig(count);
            const effectiveMarginTop = 0.2;

            for(let i=0; i<canvases.length; i+=count){
                let slide = pptx.addSlide();

                for(let j=0; j<count; j++){
                    if(i+j < canvases.length){
                        const c = canvases[i+j];
                        
                        const colIndex = j % layout.cols;
                        const rowIndex = Math.floor(j / layout.cols);

                        const xPos = layout.marginX + (colIndex * (layout.chartW + layout.gap));
                        const yPos = effectiveMarginTop + (rowIndex * (layout.chartH + layout.gap));
                        
                        const imgData = c.toDataURL("image/png");
                        slide.addImage({	
                            data: imgData,	
                            x: xPos,	
                            y: yPos,	
                            w: layout.chartW,	
                            h: layout.chartH	
                        });
                    }
                }
            }

            pptx.writeFile({ fileName: `KPI_Report_${new Date().getTime()}.pptx` });
            closePPTExport();
        }

        // --- INITIALIZATION ---
        function initDashboard() {
            // Set default selected KPIs
            selectedKpis = kpiDefinitions.filter(k => k.initialChecked).map(k => k.tech + " - " + k.kpi);
            
            // Initialize with default chart style
            applyChartStyle(1);
            
            // Fetch initial data
            fetchData();
        }
    </script>
</body>
</html>

<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <title>KPI Dashboard</title>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/pptxgenjs@3.12.0/dist/pptxgen.bundle.js"></script>
    <style>
        body { font-family:'Segoe UI', sans-serif; margin:0; padding:0; background:#f4f7f6; }
        header { text-align:center; padding:15px 0; font-size:28px; font-weight:700; color:#333; background:white; box-shadow:0 2px 4px rgba(0,0,0,0.05); margin-bottom:15px; }
        
        /* --- UNIFIED CONTROLS --- */
        .controls { 
            display: flex; 
            justify-content: center; 
            gap: 15px; 
            margin-bottom: 20px; 
            flex-wrap: wrap; 
            align-items: center;
            padding: 0 20px;
        }
        
        /* Toggle Switch */
        .toggle-switch {
            display: flex;
            align-items: center;
            gap: 8px;
            font-size: 14px;
            cursor: pointer;
            background: white;
            padding: 8px 16px;
            border-radius: 20px;
            border: 1px solid #ddd;
            box-shadow: 0 1px 3px rgba(0,0,0,0.1);
            min-width: 140px;
        }
        .toggle-switch .toggle-label {
            user-select: none;
            font-weight: 500;
            color: #666;
        }
        .toggle-switch .switch {
            width: 50px;
            height: 24px;
            background: #ccc;
            border-radius: 12px;
            position: relative;
            transition: background 0.3s;
        }
        .toggle-switch .switch .circle {
            width: 20px;
            height: 20px;
            background: white;
            border-radius: 50%;
            position: absolute;
            top: 2px;
            left: 2px;
            transition: left 0.3s;
        }
        .toggle-switch.active .switch {
            background: #2F80ED;
        }
        .toggle-switch.active .switch .circle {
            left: 28px;
        }
        .toggle-switch.active .toggle-label:first-child {
            color: #333;
            font-weight: 600;
        }
        .toggle-switch:not(.active) .toggle-label:last-child {
            color: #333;
            font-weight: 600;
        }
        
        /* Tech Filters */
        .tech-filters { 
            display: flex; 
            gap: 8px; 
            background: white;
            padding: 6px;
            border-radius: 8px;
            box-shadow: 0 1px 3px rgba(0,0,0,0.1);
        }
        .tech-filter-btn { 
            padding: 8px 16px; 
            border: none; 
            border-radius: 6px; 
            background: #f5f5f5; 
            cursor: pointer; 
            font-size: 13px; 
            font-weight: 600; 
            transition: 0.2s;
            display: flex;
            align-items: center;
            gap: 5px;
        }
        .tech-filter-btn:before {
            content: '';
            width: 12px;
            height: 12px;
            border-radius: 50%;
            display: inline-block;
        }
        .tech-filter-btn.gsm:before { background: #2F80ED; }
        .tech-filter-btn.lte:before { background: #27AE60; }
        .tech-filter-btn.nr:before { background: #D24726; }
        .tech-filter-btn.active { 
            color: white; 
        }
        .tech-filter-btn.gsm.active { background: #2F80ED; }
        .tech-filter-btn.lte.active { background: #27AE60; }
        .tech-filter-btn.nr.active { background: #D24726; }
        
        /* Unified Dropdowns (always visible) */
        .control-group {
            position: relative;
            min-width: 200px;
        }
        .dropdown-btn {
            padding: 10px 16px;
            background: white;
            color: #333;
            border: 1px solid #ddd;
            border-radius: 6px;
            width: 100%;
            text-align: left;
            display: flex;
            justify-content: space-between;
            align-items: center;
            cursor: pointer;
            font-size: 14px;
            box-shadow: 0 1px 3px rgba(0,0,0,0.1);
        }
        .dropdown-btn:hover {
            border-color: #2F80ED;
        }
        .dropdown-list {
            position: absolute;
            top: 105%;
            left: 0;
            background: white;
            border: 1px solid #ddd;
            border-radius: 6px;
            max-height: 300px;
            overflow-y: auto;
            display: none;
            z-index: 100;
            width: 100%;
            box-shadow: 0 4px 12px rgba(0,0,0,0.1);
        }
        .dropdown-item {
            padding: 8px 12px;
            cursor: pointer;
            font-size: 13px;
            border-bottom: 1px solid #f5f5f5;
            display: flex;
            align-items: center;
            gap: 8px;
        }
        .dropdown-item:hover {
            background: #f0f7ff;
        }
        .dropdown-item input[type="checkbox"] {
            margin: 0;
        }
        
        /* Search bar */
        .search-container {
            position: relative;
            width: 100%;
        }
        .search-input {
            width: 100%;
            padding: 10px 16px 10px 40px;
            border: 1px solid #ddd;
            border-radius: 6px;
            font-size: 14px;
            box-sizing: border-box;
        }
        .search-icon {
            position: absolute;
            left: 12px;
            top: 50%;
            transform: translateY(-50%);
            color: #999;
        }
        
        /* Action Buttons */
        .action-btn { 
            padding: 10px 20px; 
            cursor: pointer; 
            border: none; 
            background: #2F80ED; 
            color: white; 
            border-radius: 6px; 
            font-weight: 600; 
            transition: 0.2s;
            display: flex;
            align-items: center;
            gap: 8px;
            white-space: nowrap;
        }
        .action-btn:hover { background: #1f5ab5; }
        .ppt-btn { background: #D24726 !important; }
        .ppt-btn:hover { background: #a8381e !important; }
        
        /* Chart Grid */
        .chart-grid { display:grid; grid-template-columns: repeat(3, 1fr); gap:20px; padding:0 20px 40px 20px; max-width: 1800px; margin: 0 auto; }
        @media (max-width: 1400px) { .chart-grid { grid-template-columns: repeat(2, 1fr); } }
        @media (max-width: 768px) { .chart-grid { grid-template-columns: 1fr; } }
        .chart-card { background:white; border-radius:8px; padding:15px; box-shadow:0 2px 8px rgba(0,0,0,0.08); display:flex; flex-direction:column; }
        .chart-container { position: relative; height: 280px; width: 100%; }
        .chart-site-info { 
            font-size: 12px; 
            color: #666; 
            margin-bottom: 10px; 
            padding: 5px 10px; 
            background: #f5f5f5; 
            border-radius: 4px; 
            display: flex;
            align-items: center;
            gap: 5px;
        }
        .chart-site-info:before {
            content: 'üìä';
        }
        
        /* Drawers */
        .drawer-toggle-buttons { position: fixed; top: 20px; right: 0; display: flex; flex-direction: column; gap: 8px; z-index: 900; }
        .chartStyleDrawerToggle, .kpiDrawerToggle { width: 36px; height: 36px; background: #8E44AD; color: white; border-radius: 6px 0 0 6px; cursor: pointer; display: flex; align-items: center; justify-content: center; font-size: 20px; transition: 0.2s; }
        .kpiDrawerToggle { background: #2F80ED; margin-top: 8px; }
        
        .chartStyleDrawer, .kpiDrawer { position: fixed; top: 0; right: 0; width: 320px; height: 100%; background: white; box-shadow: -2px 0 10px rgba(0,0,0,0.1); z-index: 1000; transform: translateX(100%); transition: 0.3s; padding: 20px; display: flex; flex-direction: column; }
        .chartStyleDrawer.open, .kpiDrawer.open { transform: translateX(0); }
        
        .drawer-header { display: flex; justify-content: space-between; align-items: center; margin-bottom: 15px; padding-bottom: 10px; border-bottom: 1px solid #eee; }
        .kpi-options-body, .style-options-body { flex-grow: 1; overflow-y: auto; padding-right: 5px; padding-bottom: 40px; }
        .drawer-controls { display: flex; gap: 5px; align-items: center; margin-bottom: 15px; }
        .drawer-controls .action-btn { padding: 6px 10px; font-size: 13px; }
        .kpi-group-title { font-weight: bold; color: #2F80ED; margin-top: 15px; margin-bottom: 5px; border-bottom: 1px solid #eee; padding-bottom: 3px; }
        .kpi-option { display: block; margin-bottom: 5px; cursor: pointer; user-select: none; padding: 5px; border-radius: 4px; }
        .kpi-option:hover { background: #f5f5f5; }
        .kpi-option input[type="checkbox"] { margin-right: 8px; }
        .style-button { padding: 10px 12px; margin: 6px 0; background: #f5f5f5; border-radius: 6px; cursor: pointer; font-weight: 500; border: 1px solid #ddd; transition: 0.2s; }
        .style-button:hover { background: #e9e9e9; }
        .style-button.active { background: #8E44AD; color: white; border-color: #8E44AD; }
        .tech-color-buttons { display: grid; grid-template-columns: repeat(2, 1fr); gap: 8px; margin-top: 15px; }
        .tech-color-btn { padding: 8px; border: none; border-radius: 6px; cursor: pointer; font-weight: 500; color: white; text-align: center; }
        .tech-color-btn.gsm { background: #2F80ED; }
        .tech-color-btn.lte { background: #27AE60; }
        .tech-color-btn.nr { background: #D24726; }
        
        /* Modal styles */
        .modal { position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.6); z-index: 2001; display: none; align-items: center; justify-content: center; backdrop-filter: blur(3px); }
        .modal-content { background: white; width: 95%; max-width: 1400px; height: 90vh; border-radius: 12px; display: flex; flex-direction: column; box-shadow: 0 10px 25px rgba(0,0,0,0.3); }
        .modal-header { padding: 15px 20px; border-bottom: 1px solid #eee; display: flex; justify-content: space-between; align-items: center; font-weight: bold; font-size: 18px; }
        .modal-body { flex: 1; display: flex; padding: 0; overflow: hidden; }
        #previewBody { flex: 1; overflow-y: auto; padding: 20px; background: #f5f5f5; }
        .preview-slide { background: white; border: 1px solid #ddd; margin-bottom: 20px; padding: 20px; box-shadow: 0 2px 5px rgba(0,0,0,0.05); aspect-ratio: 16/9; position: relative; }
        .preview-slide-title { position: absolute; top: 10px; left: 20px; font-size: 16px; font-weight: bold; color: #D24726; }
        .preview-grid { display: grid; height: 100%; align-items: center; padding-top: 30px; }
        .preview-img-box { text-align: center; padding: 5px; height: 100%; display: flex; flex-direction: column; justify-content: center; }
        .preview-img-box img { max-width: 100%; max-height: calc(100% - 20px); object-fit: contain; border: 1px solid #eee; }
        #previewSettingsPanel { width: 250px; background: #fff; border-left: 1px solid #eee; padding: 20px; display: flex; flex-direction: column; flex-shrink: 0; }
        .settings-group { margin-bottom: 20px; }
        .settings-group h4 { margin-top: 0; margin-bottom: 10px; font-size: 14px; color: #555; border-bottom: 1px solid #eee; padding-bottom: 5px; }
        .graph-options { display: flex; flex-wrap: wrap; gap: 5px; }
        .graph-options button { padding: 6px 10px; font-size: 13px; background: #f0f0f0; border: 1px solid #ddd; border-radius: 4px; cursor: pointer; }
        .graph-options button.active { background: #2F80ED; color: white; border-color: #2F80ED; }
        .tech-export-options { display: flex; flex-direction: column; gap: 5px; }
        .tech-export-option { display: flex; align-items: center; gap: 8px; }
        .tech-export-option input { margin: 0; }
        .modal-footer { padding: 15px 20px; border-top: 1px solid #eee; text-align: right; flex-shrink: 0; }
        
        /* Loading state */
        .loading { text-align: center; padding: 40px; color: #666; }
        
        /* Site tech indicators */
        .site-tech-indicator {
            display: inline-block;
            width: 8px;
            height: 8px;
            border-radius: 50%;
            margin-right: 5px;
        }
        .site-tech-gsm { background: #2F80ED; }
        .site-tech-lte { background: #27AE60; }
        .site-tech-nr { background: #D24726; }
    </style>
</head>
<body onload="initDashboard()">
    <header>KPI Dashboard</header>

    <div class="controls">
        <!-- Level Toggle Switch -->
        <div class="toggle-switch" id="levelToggle" onclick="switchLevel()">
            <span class="toggle-label">Group Level</span>
            <div class="switch">
                <div class="circle"></div>
            </div>
            <span class="toggle-label">Site Level</span>
        </div>
        
        <!-- Technology Filters -->
        <div class="tech-filters" id="techFilters">
            <button class="tech-filter-btn gsm active" onclick="toggleTechFilter('GSM')">GSM</button>
            <button class="tech-filter-btn lte active" onclick="toggleTechFilter('LTE')">LTE</button>
            <button class="tech-filter-btn nr active" onclick="toggleTechFilter('NR')">NR</button>
        </div>
        
        <!-- Date Dropdown (always visible) -->
        <div class="control-group">
            <button class="dropdown-btn" id="dateDropdownBtn">
                <span id="dateBtnLabel">All Dates</span>
                <span>‚ñº</span>
            </button>
            <div class="dropdown-list" id="dateDropdownList">
                <div class="search-container">
                    <div class="search-icon">üîç</div>
                    <input type="text" class="search-input" placeholder="Search dates..." id="dateSearch" onkeyup="filterDropdown('date')">
                </div>
                <!-- Dates will be populated here -->
            </div>
        </div>
        
        <!-- Site Dropdown (always visible but content changes based on date selection) -->
        <div class="control-group">
            <button class="dropdown-btn" id="siteDropdownBtn">
                <span id="siteBtnLabel">All Sites</span>
                <span>‚ñº</span>
            </button>
            <div class="dropdown-list" id="siteDropdownList">
                <div class="search-container">
                    <div class="search-icon">üîç</div>
                    <input type="text" class="search-input" placeholder="Search sites..." id="siteSearch" onkeyup="filterDropdown('site')">
                </div>
                <!-- Sites will be populated here -->
            </div>
        </div>
        
        <!-- Action Buttons -->
        <button class="action-btn" onclick="openPPTExport()">
            <span>üìä</span> Export PPT
        </button>
        <button class="action-btn" onclick="refreshData()">
            <span>üîÑ</span> Refresh
        </button>
    </div>

    <div class="chart-grid" id="mainChartContainer"></div>

    <!-- Drawer Toggle Buttons -->
    <div class="drawer-toggle-buttons">
        <div class="chartStyleDrawerToggle" onclick="toggleChartStyleDrawer()">üé®</div>
        <div class="kpiDrawerToggle" onclick="toggleDrawer()">‚öô</div>
    </div>

    <!-- Chart Style Drawer -->
    <div id="chartStyleDrawer" class="chartStyleDrawer">
        <div class="drawer-header"> 
            <h3>Chart Styles</h3> 
            <button onclick="toggleChartStyleDrawer()" style="border:none;background:none;font-size:22px;cursor:pointer;">‚úï</button> 
        </div>
        <div class="style-options-body">
            <div class="style-button" onclick="applyChartStyle(0)">Filled Area</div>
            <div class="style-button" onclick="applyChartStyle(1)">Line with Dots</div>
            <div class="style-button" onclick="applyChartStyle(2)">Smooth Line</div>
            <div class="style-button" onclick="applyChartStyle(3)">Thick Line</div>
            <div class="style-button" onclick="applyChartStyle(4)">Thin Line with dots</div>
            
            <div style="margin:20px 0;border-top:1px solid #eee;padding-top:15px;">
                <label><b>Technology Colors</b></label>
                <div class="tech-color-buttons">
                    <button class="tech-color-btn gsm" onclick="openColorPicker('GSM')">GSM Color</button>
                    <button class="tech-color-btn lte" onclick="openColorPicker('LTE')">LTE Color</button>
                    <button class="tech-color-btn nr" onclick="openColorPicker('NR')">NR Color</button>
                </div>
            </div>
        </div>
    </div>

    <!-- KPI Drawer -->
    <div id="kpiDrawer" class="kpiDrawer">
        <div class="drawer-header"> 
            <h3 id="drawerHeaderTitle">KPI Settings</h3> 
            <button onclick="toggleDrawer()" style="border:none;background:none;font-size:24px;cursor:pointer;color:#777;">‚úï</button> 
        </div>
        <div class="drawer-controls">
            <button class="action-btn" onclick="selectVisibleKpis()" style="background:#5cb85c;">Select All</button>
            <button class="action-btn" onclick="clearVisibleKpis()" style="background:#f0ad4e;">Clear All</button>
            <button class="action-btn" onclick="applyKpis()" style="background:#2F80ED;">Apply</button>
        </div>
        <div class="kpi-options-body" id="kpiOptionsList"></div>
    </div>

    <!-- PPT Export Modal -->
    <div id="pptModal" class="modal">
        <div class="modal-content">
            <div class="modal-header">
                <span>PPT Export Preview</span>
                <button onclick="closePPTExport()" style="border:none;background:none;font-size:20px;cursor:pointer;">‚úï</button>
            </div>
            <div class="modal-body">
                <div id="previewBody"></div>
                <div id="previewSettingsPanel">
                    <h3>Export Settings</h3>
                    <div class="settings-group">
                        <h4>Layout</h4>
                        <div class="graph-options">
                            <button onclick="updatePPTPreview(1)" data-count="1">1 Graph</button>
                            <button onclick="updatePPTPreview(2)" data-count="2">2 Graphs</button>
                            <button onclick="updatePPTPreview(3)" data-count="3">3 Graphs</button>
                            <button onclick="updatePPTPreview(4)" data-count="4">4 Graphs</button>
                            <button onclick="updatePPTPreview(6)" data-count="6">6 Graphs</button>
                            <button onclick="updatePPTPreview(9)" data-count="9">9 Graphs</button>
                        </div>
                    </div>
                    <div class="settings-group">
                        <h4>Select Technologies</h4>
                        <div class="tech-export-options" id="techExportOptions"></div>
                    </div>
                </div>
            </div>
            <div class="modal-footer">
                <button class="action-btn" onclick="closePPTExport()" style="background:#888;">Cancel</button>
                <button class="action-btn ppt-btn" onclick="downloadPPT()" style="background:#D24726;">Download PPT</button>
            </div>
        </div>
    </div>

    <script>
        // --- CONFIG ---
        const sheetConfig = {
            group: {
                GSM: "https://docs.google.com/spreadsheets/d/e/2PACX-1vRIeWBt5CB8zpdFja0b3h2kodVsUrjD_PSHOkF93MkecZF04gWDoMXVq-q0REU-RvFQbjVggJVDLpUi/pub?gid=1977848975&single=true&output=csv",
                LTE: "https://docs.google.com/spreadsheets/d/e/2PACX-1vRIeWBt5CB8zpdFja0b3h2kodVsUrjD_PSHOkF93MkecZF04gWDoMXVq-q0REU-RvFQbjVggJVDLpUi/pub?gid=893314169&single=true&output=csv",
                NR: "https://docs.google.com/spreadsheets/d/e/2PACX-1vRIeWBt5CB8zpdFja0b3h2kodVsUrjD_PSHOkF93MkecZF04gWDoMXVq-q0REU-RvFQbjVggJVDLpUi/pub?gid=1372365834&single=true&output=csv"
            },
            site: {
                GSM: "https://docs.google.com/spreadsheets/d/e/2PACX-1vRIeWBt5CB8zpdFja0b3h2kodVsUrjD_PSHOkF93MkecZF04gWDoMXVq-q0REU-RvFQbjVggJVDLpUi/pub?gid=1930867305&single=true&output=csv",
                LTE: "https://docs.google.com/spreadsheets/d/e/2PACX-1vRIeWBt5CB8zpdFja0b3h2kodVsUrjD_PSHOkF93MkecZF04gWDoMXVq-q0REU-RvFQbjVggJVDLpUi/pub?gid=0&single=true&output=csv",
                NR: "https://docs.google.com/spreadsheets/d/e/2PACX-1vRIeWBt5CB8zpdFja0b3h2kodVsUrjD_PSHOkF93MkecZF04gWDoMXVq-q0REU-RvFQbjVggJVDLpUi/pub?gid=1617739873&single=true&output=csv",
                cutover: "https://docs.google.com/spreadsheets/d/e/2PACX-1vRIeWBt5CB8zpdFja0b3h2kodVsUrjD_PSHOkF93MkecZF04gWDoMXVq-q0REU-RvFQbjVggJVDLpUi/pub?gid=19616562&single=true&output=csv"
            }
        };

        const kpiDefinitions = [
            { tech: "GSM", kpi: "Call setup success rate(%)", initialChecked: true, color: "#2F80ED" },
            { tech: "GSM", kpi: "Call drop rate(%)", initialChecked: true, color: "#2F80ED" },
            { tech: "GSM", kpi: "CS Traffic (erl)", initialChecked: true, color: "#2F80ED" },
            { tech: "LTE", kpi: "Call Setup Success Rate(%)", initialChecked: true, color: "#27AE60" },
            { tech: "LTE", kpi: "E-RAB Call Drop Rate(%)", initialChecked: true, color: "#27AE60" },
            { tech: "LTE", kpi: "DL -USER Average Throughput (Mbit/s)", initialChecked: true, color: "#27AE60" },
            { tech: "LTE", kpi: "UL -USER Average Throughput (Mbit/s)", initialChecked: true, color: "#27AE60" },
            { tech: "LTE", kpi: "DL Data Total Volume (Gbyte)", initialChecked: true, color: "#27AE60" },
            { tech: "LTE", kpi: "UL Data Total Volume (Gbyte)", initialChecked: true, color: "#27AE60" },
            { tech: "LTE", kpi: "DL PRB Utilization (%)", initialChecked: true, color: "#27AE60" },
            { tech: "NR", kpi: "SgNB Addition Success Rate (CU)(%)", initialChecked: true, color: "#D24726" },
            { tech: "NR", kpi: "DL Traffic Volume (GB)", initialChecked: true, color: "#D24726" },
            { tech: "NR", kpi: "DL User Throughput(Mbps)", initialChecked: true, color: "#D24726" },
        ];

        const chartStyles = [
            { name: "Filled Area", borderWidth: 2, pointRadius: 0, tension: 0.2, fill: true, backgroundColor: "rgba(47, 128, 237, 0.1)" },
            { name: "Line with Dots", borderWidth: 3, pointRadius: 5, tension: 0.4, fill: false },
            { name: "Smooth Line", borderWidth: 2, pointRadius: 0, tension: 0.4, fill: false },
            { name: "Thick Line", borderWidth: 4, pointRadius: 0, tension: 0.3, fill: false },
            { name: "Thin Line with dots", borderWidth: 2, pointRadius: 4, tension: 0, fill: false }
        ];

        // --- STATE ---
        let allData = [], allCharts = {}, selectedKpis = [];
        let pptLayout = 9, selectedTechForExport = { GSM: true, LTE: true, NR: true };
        let currentLevel = 'group'; // 'group' or 'site'
        let techFilters = { GSM: true, LTE: true, NR: true };
        let activeChartStyle = null;
        let techColors = { GSM: "#2F80ED", LTE: "#27AE60", NR: "#D24726" };
        
        // Site management state
        let allSites = []; // All sites from cutover sheet: {name, tech, onAirDate, linkedSites}
        let siteCutoverMap = {}; // site name -> onAirDate
        let selectedSites = [];
        let allOnAirDates = [];
        let selectedOnAirDates = [];
        let sitesByDate = {}; // date -> [sites]

        // --- INIT ---
        async function initDashboard() {
            selectedKpis = kpiDefinitions.filter(k => k.initialChecked).map(k => k.tech + " - " + k.kpi);
            applyChartStyle(1);
            
            // Setup dropdown event listeners
            setupDropdowns();
            
            // Load cutover data first
            await loadCutoverData();
            
            // Then fetch KPI data
            await fetchData();
        }

        // --- LEVEL MANAGEMENT ---
        function switchLevel() {
            const toggle = document.getElementById('levelToggle');
            if (currentLevel === 'group') {
                currentLevel = 'site';
                toggle.classList.add('active');
                document.getElementById('siteBtnLabel').textContent = 'Select Sites';
            } else {
                currentLevel = 'group';
                toggle.classList.remove('active');
                document.getElementById('siteBtnLabel').textContent = 'All Sites';
            }
            fetchData();
        }

        function toggleTechFilter(tech) {
            techFilters[tech] = !techFilters[tech];
            const btn = document.querySelector(`.tech-filter-btn.${tech.toLowerCase()}`);
            btn.classList.toggle('active', techFilters[tech]);
            
            // Update site dropdown when tech filters change
            updateSiteDropdown();
            fetchData();
        }

        // --- DROPDOWN SETUP ---
        function setupDropdowns() {
            // Date dropdown
            document.getElementById('dateDropdownBtn').onclick = function(e) {
                e.stopPropagation();
                const list = document.getElementById('dateDropdownList');
                list.style.display = list.style.display === 'block' ? 'none' : 'block';
                document.getElementById('siteDropdownList').style.display = 'none';
            };
            
            // Site dropdown
            document.getElementById('siteDropdownBtn').onclick = function(e) {
                e.stopPropagation();
                const list = document.getElementById('siteDropdownList');
                list.style.display = list.style.display === 'block' ? 'none' : 'block';
                document.getElementById('dateDropdownList').style.display = 'none';
            };
            
            // Close dropdowns when clicking outside
            document.addEventListener('click', function(e) {
                if (!e.target.closest('.control-group')) {
                    document.getElementById('siteDropdownList').style.display = 'none';
                    document.getElementById('dateDropdownList').style.display = 'none';
                }
            });
        }

        function filterDropdown(type) {
            const searchId = type === 'date' ? 'dateSearch' : 'siteSearch';
            const listId = type === 'date' ? 'dateDropdownList' : 'siteDropdownList';
            const searchTerm = document.getElementById(searchId).value.toLowerCase();
            
            const items = document.querySelectorAll(`#${listId} .dropdown-item`);
            items.forEach(item => {
                const text = item.textContent.toLowerCase();
                item.style.display = text.includes(searchTerm) ? 'flex' : 'none';
            });
        }

        // --- CUTOVER DATA LOADING ---
        async function loadCutoverData() {
            try {
                const res = await fetch(sheetConfig.site.cutover + "&t=" + Date.now());
                const text = await res.text();
                const rows = text.trim().split('\n').map(r => r.split(','));
                const headers = rows.shift().map(h => h.trim().toLowerCase());
                
                const enodebCol = headers.findIndex(h => h.includes('enodeb') || h.includes('site'));
                const gbscCol = headers.findIndex(h => h.includes('gbsc') || h.includes('gsm'));
                const gnbCol = headers.findIndex(h => h.includes('gnodeb') || h.includes('nr'));
                const dateCol = headers.findIndex(h => h.includes('date') || h.includes('on-air'));
                
                allSites = [];
                siteCutoverMap = {};
                sitesByDate = {};
                
                rows.forEach(row => {
                    const enodebName = enodebCol !== -1 ? row[enodebCol]?.trim() : null;
                    const onAirDate = dateCol !== -1 ? row[dateCol]?.trim() : null;
                    const gbscName = gbscCol !== -1 ? row[gbscCol]?.trim() : null;
                    const gnbName = gnbCol !== -1 ? row[gnbCol]?.trim() : null;
                    
                    if (enodebName) {
                        // Add LTE site (eNodeB)
                        const lteSite = {
                            name: enodebName,
                            tech: "LTE",
                            onAirDate: onAirDate || 'Unknown',
                            linkedSites: []
                        };
                        
                        if (gbscName) {
                            lteSite.linkedSites.push({name: gbscName, tech: "GSM"});
                            // Also add GSM site
                            allSites.push({
                                name: gbscName,
                                tech: "GSM",
                                onAirDate: onAirDate || 'Unknown',
                                linkedSites: [{name: enodebName, tech: "LTE"}]
                            });
                            siteCutoverMap[gbscName] = onAirDate || 'Unknown';
                        }
                        
                        if (gnbName) {
                            lteSite.linkedSites.push({name: gnbName, tech: "NR"});
                            // Also add NR site
                            allSites.push({
                                name: gnbName,
                                tech: "NR",
                                onAirDate: onAirDate || 'Unknown',
                                linkedSites: [{name: enodebName, tech: "LTE"}]
                            });
                            siteCutoverMap[gnbName] = onAirDate || 'Unknown';
                        }
                        
                        allSites.push(lteSite);
                        siteCutoverMap[enodebName] = onAirDate || 'Unknown';
                        
                        // Group by date
                        const dateKey = onAirDate || 'Unknown';
                        if (!sitesByDate[dateKey]) {
                            sitesByDate[dateKey] = [];
                        }
                        sitesByDate[dateKey].push(lteSite);
                        if (gbscName) sitesByDate[dateKey].push({name: gbscName, tech: "GSM"});
                        if (gnbName) sitesByDate[dateKey].push({name: gnbName, tech: "NR"});
                    }
                });
                
                // Extract unique dates
                allOnAirDates = [...new Set(allSites.map(s => s.onAirDate).filter(d => d))].sort();
                selectedOnAirDates = [...allOnAirDates]; // Select all by default
                
                // Select all sites by default
                selectedSites = allSites.map(s => s.name);
                
                console.log('Loaded sites:', allSites);
                console.log('Sites by date:', sitesByDate);
                
                // Update dropdowns
                updateDateDropdown();
                updateSiteDropdown();
                
            } catch (error) {
                console.error("Error loading cutover data:", error);
                // Fallback data
                allSites = [
                    { name: "GBSC_001", tech: "GSM", onAirDate: "2024-01-15", linkedSites: [{name: "eNodeB_001", tech: "LTE"}] },
                    { name: "eNodeB_001", tech: "LTE", onAirDate: "2024-01-15", linkedSites: [{name: "GBSC_001", tech: "GSM"}, {name: "gNodeB_001", tech: "NR"}] },
                    { name: "gNodeB_001", tech: "NR", onAirDate: "2024-01-15", linkedSites: [{name: "eNodeB_001", tech: "LTE"}] },
                    { name: "GBSC_002", tech: "GSM", onAirDate: "2024-02-01", linkedSites: [{name: "eNodeB_002", tech: "LTE"}] },
                    { name: "eNodeB_002", tech: "LTE", onAirDate: "2024-02-01", linkedSites: [{name: "GBSC_002", tech: "GSM"}] },
                ];
                
                allOnAirDates = ["2024-01-15", "2024-02-01"];
                selectedOnAirDates = [...allOnAirDates];
                selectedSites = allSites.map(s => s.name);
                
                // Group by date
                sitesByDate = {
                    "2024-01-15": allSites.filter(s => s.onAirDate === "2024-01-15"),
                    "2024-02-01": allSites.filter(s => s.onAirDate === "2024-02-01")
                };
                
                updateDateDropdown();
                updateSiteDropdown();
            }
        }

        function updateDateDropdown() {
            const list = document.getElementById('dateDropdownList');
            const btnLabel = document.getElementById('dateBtnLabel');
            
            // Clear existing items except search
            const searchContainer = list.querySelector('.search-container');
            list.innerHTML = '';
            if (searchContainer) list.appendChild(searchContainer);
            
            // Select All / Clear All
            const selectAllDiv = document.createElement('div');
            selectAllDiv.className = 'dropdown-item';
            selectAllDiv.innerHTML = '<b>‚úì Select All</b>';
            selectAllDiv.onclick = (e) => {
                e.stopPropagation();
                selectedOnAirDates = [...allOnAirDates];
                updateDateDropdown();
                updateSiteDropdown();
                fetchData();
            };
            list.appendChild(selectAllDiv);
            
            const clearAllDiv = document.createElement('div');
            clearAllDiv.className = 'dropdown-item';
            clearAllDiv.innerHTML = '<b>‚úó Clear All</b>';
            clearAllDiv.onclick = (e) => {
                e.stopPropagation();
                selectedOnAirDates = [];
                updateDateDropdown();
                updateSiteDropdown();
                fetchData();
            };
            list.appendChild(clearAllDiv);
            
            // Add divider
            const divider = document.createElement('div');
            divider.style.borderTop = '1px solid #eee';
            divider.style.margin = '5px 0';
            list.appendChild(divider);
            
            // Date list
            allOnAirDates.forEach(date => {
                const div = document.createElement('div');
                div.className = 'dropdown-item';
                
                const checkbox = document.createElement('input');
                checkbox.type = 'checkbox';
                checkbox.checked = selectedOnAirDates.includes(date);
                checkbox.onchange = (e) => {
                    e.stopPropagation();
                    if (checkbox.checked) {
                        if (!selectedOnAirDates.includes(date)) {
                            selectedOnAirDates.push(date);
                        }
                    } else {
                        selectedOnAirDates = selectedOnAirDates.filter(d => d !== date);
                    }
                    updateDateDropdown();
                    updateSiteDropdown();
                    fetchData();
                };
                
                const label = document.createElement('span');
                label.textContent = date;
                
                div.appendChild(checkbox);
                div.appendChild(label);
                div.onclick = (e) => {
                    if (e.target !== checkbox) {
                        checkbox.checked = !checkbox.checked;
                        checkbox.onchange(e);
                    }
                };
                list.appendChild(div);
            });
            
            // Update button label
            if (selectedOnAirDates.length === 0) {
                btnLabel.textContent = 'No dates selected';
            } else if (selectedOnAirDates.length === allOnAirDates.length) {
                btnLabel.textContent = 'All Dates';
            } else {
                btnLabel.textContent = `${selectedOnAirDates.length} dates selected`;
            }
        }

        function updateSiteDropdown() {
            const list = document.getElementById('siteDropdownList');
            const btnLabel = document.getElementById('siteBtnLabel');
            
            // Clear existing items except search
            const searchContainer = list.querySelector('.search-container');
            list.innerHTML = '';
            if (searchContainer) list.appendChild(searchContainer);
            
            // Get sites for selected dates
            let availableSites = [];
            if (selectedOnAirDates.length === 0) {
                availableSites = [];
            } else if (selectedOnAirDates.length === allOnAirDates.length) {
                availableSites = [...allSites];
            } else {
                availableSites = allSites.filter(site => 
                    selectedOnAirDates.includes(site.onAirDate)
                );
            }
            
            // Filter by technology
            availableSites = availableSites.filter(site => techFilters[site.tech]);
            
            // Select All / Clear All
            const selectAllDiv = document.createElement('div');
            selectAllDiv.className = 'dropdown-item';
            selectAllDiv.innerHTML = '<b>‚úì Select All</b>';
            selectAllDiv.onclick = (e) => {
                e.stopPropagation();
                selectedSites = availableSites.map(s => s.name);
                updateSiteDropdown();
                fetchData();
            };
            list.appendChild(selectAllDiv);
            
            const clearAllDiv = document.createElement('div');
            clearAllDiv.className = 'dropdown-item';
            clearAllDiv.innerHTML = '<b>‚úó Clear All</b>';
            clearAllDiv.onclick = (e) => {
                e.stopPropagation();
                selectedSites = [];
                updateSiteDropdown();
                fetchData();
            };
            list.appendChild(clearAllDiv);
            
            // Add divider
            const divider = document.createElement('div');
            divider.style.borderTop = '1px solid #eee';
            divider.style.margin = '5px 0';
            list.appendChild(divider);
            
            // Site list grouped by technology
            ['GSM', 'LTE', 'NR'].forEach(tech => {
                const techSites = availableSites.filter(s => s.tech === tech);
                if (techSites.length > 0) {
                    // Tech header
                    const techHeader = document.createElement('div');
                    techHeader.className = 'dropdown-item';
                    techHeader.style.background = '#f8f9fa';
                    techHeader.style.fontWeight = 'bold';
                    techHeader.style.color = tech === 'GSM' ? '#2F80ED' : tech === 'LTE' ? '#27AE60' : '#D24726';
                    techHeader.textContent = `${tech} Sites (${techSites.length})`;
                    list.appendChild(techHeader);
                    
                    // Sites for this tech
                    techSites.forEach(site => {
                        const div = document.createElement('div');
                        div.className = 'dropdown-item';
                        
                        const checkbox = document.createElement('input');
                        checkbox.type = 'checkbox';
                        checkbox.checked = selectedSites.includes(site.name);
                        checkbox.onchange = (e) => {
                            e.stopPropagation();
                            if (checkbox.checked) {
                                if (!selectedSites.includes(site.name)) {
                                    selectedSites.push(site.name);
                                }
                            } else {
                                selectedSites = selectedSites.filter(s => s !== site.name);
                            }
                            updateSiteDropdown();
                            fetchData();
                        };
                        
                        const label = document.createElement('span');
                        label.style.display = 'flex';
                        label.style.alignItems = 'center';
                        label.style.gap = '5px';
                        
                        const techDot = document.createElement('span');
                        techDot.className = `site-tech-indicator site-tech-${site.tech.toLowerCase()}`;
                        
                        const siteName = document.createElement('span');
                        siteName.textContent = site.name;
                        
                        label.appendChild(techDot);
                        label.appendChild(siteName);
                        
                        // Add linked sites info
                        if (site.linkedSites && site.linkedSites.length > 0) {
                            const linkedInfo = document.createElement('small');
                            linkedInfo.style.marginLeft = '8px';
                            linkedInfo.style.color = '#666';
                            linkedInfo.style.fontSize = '11px';
                            linkedInfo.textContent = '(' + site.linkedSites.map(ls => ls.name).join(', ') + ')';
                            label.appendChild(linkedInfo);
                        }
                        
                        div.appendChild(checkbox);
                        div.appendChild(label);
                        div.onclick = (e) => {
                            if (e.target !== checkbox) {
                                checkbox.checked = !checkbox.checked;
                                checkbox.onchange(e);
                            }
                        };
                        list.appendChild(div);
                    });
                }
            });
            
            // Update button label
            if (selectedSites.length === 0) {
                btnLabel.textContent = 'No sites selected';
            } else if (selectedSites.length === availableSites.length && availableSites.length > 0) {
                btnLabel.textContent = 'All Sites';
            } else if (selectedSites.length === 1) {
                const site = allSites.find(s => s.name === selectedSites[0]);
                btnLabel.textContent = site ? site.name : '1 site selected';
            } else {
                btnLabel.textContent = `${selectedSites.length} sites selected`;
            }
        }

        // --- DATA FETCHING ---
        async function fetchData() {
            console.log('Fetching data for level:', currentLevel);
            console.log('Tech filters:', techFilters);
            console.log('Selected sites:', selectedSites);
            console.log('Selected dates:', selectedOnAirDates);
            
            document.getElementById("mainChartContainer").innerHTML = "<div class='loading'>Loading data...</div>";
            allData = [];
            
            try {
                const urls = currentLevel === 'group' ? sheetConfig.group : sheetConfig.site;
                let dataPromises = [];
                
                for (const tech in urls) {
                    if (tech === 'cutover' || !techFilters[tech]) continue;
                    
                    dataPromises.push(
                        fetch(urls[tech] + "&t=" + Date.now())
                            .then(res => res.text())
                            .then(text => {
                                const rows = text.trim().split('\n').map(r => r.split(','));
                                const headers = rows.shift().map(h => h.trim());
                                const dateHeader = headers.find(h => h.toLowerCase().includes('date'));
                                const siteHeader = headers.find(h => 
                                    h.toLowerCase().includes('site') || 
                                    h.toLowerCase().includes('bsc') || 
                                    h.toLowerCase().includes('node') ||
                                    h.toLowerCase().includes('name')
                                );
                                
                                if (!dateHeader) {
                                    console.warn(`No date header found for ${tech}`);
                                    return [];
                                }
                                
                                const techData = [];
                                rows.forEach(r => {
                                    const obj = {};
                                    headers.forEach((h, i) => {
                                        const val = r[i] ? r[i].trim() : "";
                                        obj[h] = val === "" ? null : (isNaN(val) ? val : parseFloat(val));
                                    });
                                    
                                    if (obj[dateHeader]) {
                                        obj.Tech = tech;
                                        if (siteHeader) {
                                            obj.SiteName = obj[siteHeader] || '';
                                        }
                                        
                                        // For site level, apply site filtering
                                        if (currentLevel === 'site') {
                                            // If no sites selected, show all
                                            if (selectedSites.length === 0) {
                                                techData.push(obj);
                                            } else {
                                                // Check if this site matches any selected site
                                                const siteMatch = selectedSites.some(selectedSite => {
                                                    // Direct match
                                                    if (obj.SiteName === selectedSite) return true;
                                                    // Check if this is a linked site
                                                    const siteObj = allSites.find(s => s.name === selectedSite);
                                                    if (siteObj && siteObj.linkedSites) {
                                                        return siteObj.linkedSites.some(ls => ls.name === obj.SiteName);
                                                    }
                                                    return false;
                                                });
                                                
                                                if (siteMatch) {
                                                    techData.push(obj);
                                                }
                                            }
                                        } else {
                                            // Group level - include all
                                            techData.push(obj);
                                        }
                                    }
                                });
                                
                                console.log(`Loaded ${techData.length} records for ${tech}`);
                                return techData;
                            })
                            .catch(e => {
                                console.error(`Error loading ${tech}:`, e);
                                return [];
                            })
                    );
                }
                
                const results = await Promise.all(dataPromises);
                allData = results.flat();
                
                console.log(`Total records loaded: ${allData.length}`);
                
                if (allData.length === 0) {
                    throw new Error("No data available with current filters");
                }
                
                renderCharts();
                
            } catch(e) {
                console.error("Data error:", e);
                document.getElementById("mainChartContainer").innerHTML = 
                    `<div class='loading' style='color:#D24726;'>Error: ${e.message}</div>`;
            }
        }

        // --- CHART RENDERING ---
        function renderCharts() {
            const container = document.getElementById("mainChartContainer");
            container.innerHTML = "";
            allCharts = {};
            
            if (allData.length === 0) {
                container.innerHTML = "<div class='loading'>No data available with current filters</div>";
                return;
            }
            
            // Extract timeline from data
            const dateHeaderName = Object.keys(allData[0] || {}).find(h => h.toLowerCase().includes('date'));
            if (!dateHeaderName) {
                container.innerHTML = "<div class='loading' style='color:#D24726;'>Error: No date column found in data</div>";
                return;
            }
            
            const timeline = [...new Set(allData.map(d => d[dateHeaderName]))].sort((a,b) => {
                const [da,ma,ya] = a.split('/').map(Number);
                const [db,mb,yb] = b.split('/').map(Number);
                return new Date(ya, ma-1, da) - new Date(yb, mb-1, db);
            });
            
            if (timeline.length === 0) {
                container.innerHTML = "<div class='loading'>No timeline data available</div>";
                return;
            }
            
            const monthNames = ["Jan","Feb","Mar","Apr","May","Jun","Jul","Aug","Sep","Oct","Nov","Dec"];
            const timelineLabels = timeline.map(d => {
                const [day, month] = d.split('/').map(Number);
                return `${day} ${monthNames[month-1]}`;
            });

            const chartsToRender = kpiDefinitions.filter(k => {
                const isSelected = selectedKpis.includes(k.tech + " - " + k.kpi);
                const isTechEnabled = techFilters[k.tech];
                return isSelected && isTechEnabled;
            });
            
            if (chartsToRender.length === 0) {
                container.innerHTML = "<div class='loading'>No KPIs selected. Please select KPIs from the settings drawer (‚öô).</div>";
                return;
            }

            chartsToRender.forEach((kpiDef, idx) => {
                const fullKpiName = kpiDef.tech + " - " + kpiDef.kpi;
                const tech = kpiDef.tech;
                const kpi = kpiDef.kpi;

                const card = document.createElement("div");
                card.className = "chart-card";
                
                // Show site info for site level
                if (currentLevel === 'site' && selectedSites.length > 0) {
                    const siteInfo = document.createElement("div");
                    siteInfo.className = "chart-site-info";
                    
                    // Count sites by technology
                    const techSites = selectedSites.filter(siteName => {
                        const site = allSites.find(s => s.name === siteName);
                        return site && site.tech === tech;
                    });
                    
                    if (techSites.length > 0) {
                        siteInfo.textContent = `${tech} Sites: ${techSites.length} selected`;
                    } else {
                        // Check linked sites
                        const linkedSites = selectedSites.flatMap(siteName => {
                            const site = allSites.find(s => s.name === siteName);
                            if (site && site.linkedSites) {
                                return site.linkedSites.filter(ls => ls.tech === tech).map(ls => ls.name);
                            }
                            return [];
                        });
                        
                        if (linkedSites.length > 0) {
                            siteInfo.textContent = `${tech} Sites: ${linkedSites.length} linked`;
                        } else {
                            siteInfo.textContent = `No ${tech} sites in selection`;
                        }
                    }
                    card.appendChild(siteInfo);
                }
                
                const wrapper = document.createElement("div");
                wrapper.className = "chart-container";
                const canvas = document.createElement("canvas");
                canvas.id = `chart_${tech}_${idx}`;
                wrapper.appendChild(canvas);
                card.appendChild(wrapper);
                container.appendChild(card);

                // Calculate data points
                const dataPoints = timeline.map(date => {
                    let relevantData = allData.filter(d => 
                        d.Tech === tech && 
                        d[dateHeaderName] === date
                    );
                    
                    // For site level, filter by selected sites
                    if (currentLevel === 'site' && selectedSites.length > 0) {
                        relevantData = relevantData.filter(d => {
                            // Direct match
                            if (selectedSites.includes(d.SiteName)) return true;
                            
                            // Check if this is a linked site
                            return selectedSites.some(selectedSite => {
                                const siteObj = allSites.find(s => s.name === selectedSite);
                                if (siteObj && siteObj.linkedSites) {
                                    return siteObj.linkedSites.some(ls => ls.name === d.SiteName);
                                }
                                return false;
                            });
                        });
                    }
                    
                    const values = relevantData
                        .map(d => d[kpi])
                        .filter(v => v !== null && v !== "")
                        .map(Number)
                        .filter(v => !isNaN(v));
                    
                    if (values.length === 0) return null;
                    
                    const kpiLower = kpi.toLowerCase();
                    if (kpiLower.includes('%') || kpiLower.includes('rate') || kpiLower.includes('avg') || kpiLower.includes('average')) {
                        return values.reduce((a, b) => a + b, 0) / values.length;
                    } else {
                        return values.reduce((a, b) => a + b, 0);
                    }
                });

                const validValues = dataPoints.filter(v => v !== null);
                if (validValues.length === 0) {
                    card.innerHTML = `<div class='loading'>No ${tech} data available</div>`;
                    return;
                }

                createChart(canvas, fullKpiName, timelineLabels, dataPoints, tech, kpi, validValues);
            });
        }

        function createChart(canvas, fullKpiName, timelineLabels, dataPoints, tech, kpi, validValues) {
            const minVal = Math.min(...validValues);
            const maxVal = Math.max(...validValues);
            const { niceMin, niceMax, tickSpacing } = computeYAxis(minVal, maxVal);
            const chartColor = techColors[tech];
            
            const chartConfig = {
                type: 'line',
                data: {
                    labels: timelineLabels,
                    datasets: [{ 
                        label: currentLevel === 'site' ? `${tech} Aggregate` : kpi,
                        data: dataPoints,
                        borderColor: chartColor,
                        backgroundColor: activeChartStyle && activeChartStyle.fill ? 
                            chartColor.replace(')', ', 0.1)').replace('rgb', 'rgba') : 'transparent',
                        borderWidth: activeChartStyle ? activeChartStyle.borderWidth : 2, 
                        pointRadius: activeChartStyle ? activeChartStyle.pointRadius : 5, 
                        tension: activeChartStyle ? activeChartStyle.tension : 0.4, 
                        spanGaps: true,
                        fill: activeChartStyle ? activeChartStyle.fill : false
                    }]
                },
                options: {
                    responsive: true, 
                    maintainAspectRatio: false,
                    plugins: { 
                        legend: { display: false },
                        title: { 
                            display: true, 
                            text: `${tech} - ${kpi}${currentLevel === 'site' ? ' (Site Level)' : ''}`,
                            font: { size: 14, weight: 'bold' }, 
                            color: '#333'
                        }
                    },
                    scales: {
                        x: { 
                            ticks: { font: { size: 8 } }, 
                            grid: { display: false } 
                        },
                        y: { 
                            grid: { color: '#eee' }, 
                            min: niceMin, 
                            max: niceMax, 
                            ticks: { stepSize: tickSpacing }, 
                            beginAtZero: maxVal < 10 
                        }
                    }
                }
            };
            
            try {
                allCharts[fullKpiName] = new Chart(canvas.getContext("2d"), chartConfig);
            } catch (e) {
                console.error(`Chart error ${fullKpiName}:`, e);
            }
        }

        // --- HELPER FUNCTIONS ---
        function computeYAxis(minVal, maxVal) {
            if (minVal >= 98 && maxVal <= 100) return { niceMin: 98, niceMax: 100, tickSpacing: 0.5 };
            let minV = minVal * 0.95, maxV = maxVal * 1.05;
            if (maxVal < 10) minV = 0;
            if (maxVal > 90 && maxVal <= 100) maxV = 100;
            let range = maxV - minV;
            if (range === 0) range = Math.abs(maxV) * 0.1 || 1;
            const tickSpacing = niceNumber(range / 5, true);
            const niceMin = Math.floor(minV / tickSpacing) * tickSpacing;
            const niceMax = Math.ceil(maxV / tickSpacing) * tickSpacing;
            return { niceMin, niceMax, tickSpacing };
        }

        function niceNumber(value, round) {
            if (value === 0) return 0;
            const exponent = Math.floor(Math.log10(value));
            const fraction = value / Math.pow(10, exponent);
            let niceFraction;
            if (round) {
                if (fraction < 1.5) niceFraction = 1; 
                else if (fraction < 3) niceFraction = 2; 
                else if (fraction < 7) niceFraction = 5; 
                else niceFraction = 10;
            } else {
                if (fraction <= 1) niceFraction = 1; 
                else if (fraction <= 2) niceFraction = 2; 
                else if (fraction <= 5) niceFraction = 5; 
                else niceFraction = 10;
            }
            return niceFraction * Math.pow(10, exponent);
        }

        function refreshData() { 
            console.log('Refreshing data...');
            fetchData(); 
        }

        // --- KPI DRAWER ---
        function toggleDrawer() {
            const d = document.getElementById("kpiDrawer");
            d.classList.toggle("open");
            if (d.classList.contains("open")) populateKpiOptions();
        }

        function populateKpiOptions() {
            const list = document.getElementById("kpiOptionsList");
            list.innerHTML = "";
            let currentTech = "";
            kpiDefinitions.forEach(kpiDef => {
                const fullKpiName = kpiDef.tech + " - " + kpiDef.kpi;
                if (kpiDef.tech !== currentTech) {
                    list.innerHTML += `<div class="kpi-group-title">${kpiDef.tech} KPIs</div>`;
                    currentTech = kpiDef.tech;
                }
                const checked = selectedKpis.includes(fullKpiName) ? "checked" : "";
                const d = document.createElement("label");
                d.className = "kpi-option";
                d.innerHTML = `<input type='checkbox' value='${fullKpiName}' class='kpi-chk' ${checked}> ${kpiDef.kpi}`;
                d.onclick = (e) => {
                    if (e.target.tagName !== "INPUT") {
                        const chk = d.querySelector("input");
                        chk.checked = !chk.checked;
                    }
                };
                list.appendChild(d);
            });
        }
        
        function applyKpis() {
            const list = document.getElementById("kpiOptionsList");
            selectedKpis = Array.from(list.querySelectorAll(".kpi-chk:checked")).map(c => c.value);
            document.getElementById("kpiDrawer").classList.remove("open");
            refreshCharts();
        }

        function selectVisibleKpis() {
            selectedKpis = kpiDefinitions.map(k => k.tech + " - " + k.kpi);
            populateKpiOptions();
        }
        
        function clearVisibleKpis() {
            selectedKpis = [];
            populateKpiOptions();
        }
        
        function refreshCharts() {
            if (allData.length > 0) {
                renderCharts();
            } else {
                fetchData();
            }
        }

        // --- CHART STYLING ---
        function toggleChartStyleDrawer() {
            const d = document.getElementById("chartStyleDrawer");
            d.classList.toggle("open");
        }

        function applyChartStyle(styleIndex) {
            activeChartStyle = chartStyles[styleIndex];
            document.querySelectorAll('.style-button').forEach((btn, idx) => {
                btn.classList.toggle('active', idx === styleIndex);
            });
            updateTechColorButtons();
            refreshCharts();
        }

        function updateTechColorButtons() {
            ['gsm', 'lte', 'nr'].forEach(tech => {
                const btn = document.querySelector(`.tech-color-btn.${tech}`);
                if (btn) btn.style.background = techColors[tech.toUpperCase()];
            });
        }

        // --- COLOR PICKER ---
        function openColorPicker(tech) {
            const color = prompt(`Enter color for ${tech} (hex code):`, techColors[tech]);
            if (color) {
                techColors[tech] = color;
                kpiDefinitions.forEach(kpi => {
                    if (kpi.tech === tech) kpi.color = color;
                });
                updateTechColorButtons();
                refreshCharts();
            }
        }

        // --- PPT EXPORT ---
        function openPPTExport() {
            const charts = document.querySelectorAll("canvas");
            if (charts.length === 0) {
                alert("No charts to export.");
                return;
            }
            const techOptions = document.getElementById('techExportOptions');
            techOptions.innerHTML = '';
            for (const tech in selectedTechForExport) {
                techOptions.innerHTML += `
                    <div class="tech-export-option">
                        <input type="checkbox" id="export-${tech}" ${selectedTechForExport[tech] ? 'checked' : ''} onchange="updateTechExportSelection('${tech}', this.checked)">
                        <label for="export-${tech}">${tech}</label>
                    </div>
                `;
            }
            document.querySelectorAll('.graph-options button').forEach(btn => {
                btn.classList.toggle('active', parseInt(btn.dataset.count) === pptLayout);
            });
            updatePPTPreview(pptLayout);
            document.getElementById('pptModal').style.display = 'flex';
        }

        function closePPTExport() {
            document.getElementById('pptModal').style.display = 'none';
        }

        function updateTechExportSelection(tech, isSelected) {
            selectedTechForExport[tech] = isSelected;
            updatePPTPreview(pptLayout);
        }

        function updatePPTPreview(layoutCount) {
            pptLayout = layoutCount;
            document.querySelectorAll('.graph-options button').forEach(btn => {
                btn.classList.toggle('active', parseInt(btn.dataset.count) === layoutCount);
            });
            
            const allChartsForExport = [];
            document.querySelectorAll("canvas").forEach(canvas => {
                const chart = Chart.getChart(canvas.id);
                if (chart) {
                    const title = chart.options.plugins.title.text;
                    const tech = title.split(' - ')[0];
                    if (selectedTechForExport[tech]) {
                        allChartsForExport.push({ canvas: canvas, title: title, tech: tech });
                    }
                }
            });
            
            const previewBody = document.getElementById('previewBody');
            previewBody.innerHTML = '';
            
            if (allChartsForExport.length === 0) {
                previewBody.innerHTML = '<div class="loading">No charts selected</div>';
                return;
            }
            
            const layout = getLayoutConfig(layoutCount);
            for (let i = 0; i < allChartsForExport.length; i += layoutCount) {
                const slide = document.createElement('div');
                slide.className = 'preview-slide';
                slide.innerHTML = `<div class="preview-slide-title">Slide ${Math.floor(i/layoutCount) + 1}</div>`;
                const grid = document.createElement('div');
                grid.className = 'preview-grid';
                grid.style.gridTemplateColumns = `repeat(${layout.cols}, 1fr)`;
                grid.style.gridTemplateRows = `repeat(${layout.rows}, 1fr)`;
                
                for (let j = 0; j < layoutCount; j++) {
                    const idx = i + j;
                    if (idx < allChartsForExport.length) {
                        const box = document.createElement('div');
                        box.className = 'preview-img-box';
                        try {
                            const tempCanvas = document.createElement('canvas');
                            tempCanvas.width = allChartsForExport[idx].canvas.width;
                            tempCanvas.height = allChartsForExport[idx].canvas.height;
                            const ctx = tempCanvas.getContext('2d');
                            ctx.drawImage(allChartsForExport[idx].canvas, 0, 0);
                            const img = document.createElement('img');
                            img.src = tempCanvas.toDataURL("image/png");
                            img.style.maxWidth = '100%';
                            img.style.maxHeight = '100%';
                            box.appendChild(img);
                            const title = document.createElement('div');
                            title.textContent = allChartsForExport[idx].title.length > 50 ? 
                                allChartsForExport[idx].title.substring(0, 50) + '...' : allChartsForExport[idx].title;
                            title.style.fontSize = '12px';
                            title.style.color = '#666';
                            box.appendChild(title);
                        } catch (e) {
                            box.innerHTML = '<div style="color:#D24726;">Error</div>';
                        }
                        grid.appendChild(box);
                    } else {
                        const empty = document.createElement('div');
                        empty.className = 'preview-img-box';
                        empty.style.border = '1px dashed #eee';
                        grid.appendChild(empty);
                    }
                }
                slide.appendChild(grid);
                previewBody.appendChild(slide);
            }
        }

        function getLayoutConfig(count) {
            let rows, cols;
            switch(count) {
                case 1: rows = 1; cols = 1; break;
                case 2: rows = 1; cols = 2; break;
                case 3: rows = 2; cols = 2; break;
                case 4: rows = 2; cols = 2; break;
                case 6: rows = 2; cols = 3; break;
                case 9: rows = 3; cols = 3; break;
                default: rows = 3; cols = 3;
            }
            return { rows, cols };
        }

        async function downloadPPT() {
            const pptx = new PptxGenJS();
            pptx.layout = 'LAYOUT_16x9';
            
            // Title slide
            const titleSlide = pptx.addSlide();
            titleSlide.addText('KPI Dashboard Report', { x: 0.5, y: 1, w: 9, h: 1, fontSize: 36, bold: true, color: '2F80ED' });
            titleSlide.addText(`Generated: ${new Date().toLocaleDateString()}`, { x: 0.5, y: 2, w: 9, h: 0.5, fontSize: 16, color: '666666' });
            
            const allChartsForExport = [];
            document.querySelectorAll("canvas").forEach(canvas => {
                const chart = Chart.getChart(canvas.id);
                if (chart) {
                    const title = chart.options.plugins.title.text;
                    const tech = title.split(' - ')[0];
                    if (selectedTechForExport[tech]) {
                        allChartsForExport.push({ canvas: canvas, title: title, tech: tech });
                    }
                }
            });
            
            if (allChartsForExport.length === 0) {
                alert("No charts selected.");
                return;
            }
            
            const layout = getLayoutConfig(pptLayout);
            const slideWidth = 10.0;
            const slideHeight = 5.625;
            const marginX = 0.5;
            const marginTop = 0.8;
            const marginBottom = 0.5;
            const gap = 0.2;
            const usableW = slideWidth - (marginX * 2);
            const usableH = slideHeight - marginTop - marginBottom;
            const chartW = (usableW - ((layout.cols - 1) * gap)) / layout.cols;
            const chartH = (usableH - ((layout.rows - 1) * gap)) / layout.rows;
            
            for (let i = 0; i < allChartsForExport.length; i += pptLayout) {
                const slide = pptx.addSlide();
                for (let j = 0; j < pptLayout; j++) {
                    const idx = i + j;
                    if (idx < allChartsForExport.length) {
                        const row = Math.floor(j / layout.cols);
                        const col = j % layout.cols;
                        const x = marginX + (col * (chartW + gap));
                        const y = marginTop + (row * (chartH + gap));
                        try {
                            slide.addImage({
                                data: allChartsForExport[idx].canvas.toDataURL("image/png"),
                                x: x, y: y, w: chartW, h: chartH
                            });
                            const shortTitle = allChartsForExport[idx].title.length > 40 ? 
                                allChartsForExport[idx].title.substring(0, 40) + '...' : allChartsForExport[idx].title;
                            slide.addText(shortTitle, {
                                x: x, y: y - 0.25, w: chartW, h: 0.25,
                                fontSize: 7, bold: true, color: '333333'
                            });
                        } catch (e) { console.error("PPT error:", e); }
                    }
                }
            }
            
            // Summary
            const summary = pptx.addSlide();
            summary.addText('Summary', { x: 0.5, y: 0.5, w: 9, h: 0.5, fontSize: 28, bold: true, color: '2F80ED' });
            let summaryText = `Total Charts: ${allChartsForExport.length}\n`;
            summaryText += `Layout: ${layout.rows}x${layout.cols}\n`;
            summaryText += `Level: ${currentLevel === 'group' ? 'Group' : 'Site'}\n`;
            if (currentLevel === 'site') summaryText += `Sites: ${selectedSites.length}\n`;
            summary.addText(summaryText, { x: 0.5, y: 1.5, w: 9, h: 3, fontSize: 14, color: '333333' });
            
            try {
                await pptx.writeFile({ fileName: `KPI_Report_${new Date().getTime()}.pptx` });
                closePPTExport();
            } catch (e) {
                alert("PPT Error: " + e.message);
            }
        }
    </script>
</body>
</html>
